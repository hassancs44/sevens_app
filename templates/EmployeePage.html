<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù | SEVENS</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
    body{background:#f8fbff;color:#2c3e50;min-height:100vh;}
    .navbar{background:white;padding:18px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 12px rgba(0,0,0,0.06);position:sticky;top:0;z-index:100;}
    .logo-box{display:flex;align-items:center;gap:14px;}
    .logo-box img{width:44px;height:44px;object-fit:contain;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .logo-box h1{color:#1e88e5;font-size:22px;font-weight:700;}
    .user-info{display:flex;align-items:center;gap:12px;color:#34495e;font-weight:600;}
    .logout-btn{background:#e3f2fd;color:#1976d2;border:none;padding:6px 14px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s;}
    .logout-btn:hover{background:#bbdefb;}
    .container{max-width:1100px;margin:30px auto;padding:0 20px;}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .page-title{font-size:26px;color:#0d47a1;font-weight:700;}
    .new-request-btn{padding:10px 20px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:transform .2s,box-shadow .2s;}
    .new-request-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(33,150,243,0.3);}
    .requests-grid{display:grid;gap:22px;}
    .request-card{background:white;border-radius:18px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid #eef5ff;transition:all .3s;}
    .request-card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(30,136,229,0.12);}
    .status-header{height:6px;}
    .status-Ø¬Ø¯ÙŠØ¯{background:#2196f3;}
    .status-Ù‚ÙŠØ¯-Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©{background:#9c27b0;}
    .status-Ø¬Ø§Ø±ÙŠ-Ø§Ù„ØªÙ†ÙÙŠØ°{background:#ff9800;}
    .status-Ù…Ø¹Ù„Ù‚{background:#ff5722;}
    .status-Ù…ØºÙ„Ù‚{background:#4caf50;}
    .status-Ù…Ø±ÙÙˆØ¶{background:#f44336;}
    .card-content{padding:24px;}
    .card-top{display:flex;justify-content:space-between;margin-bottom:14px;}
    .request-id{font-weight:700;color:#1e88e5;font-size:18px;}
    .request-date{color:#7f8c8d;font-size:14px;}
    .request-title{font-size:20px;margin-bottom:12px;color:#2c3e50;font-weight:600;}
    .request-desc{color:#555;margin-bottom:18px;line-height:1.6;font-size:15px;}
    .request-meta{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:18px;font-size:14px;color:#34495e;}
    .meta-item{display:flex;align-items:center;gap:6px;}
    .status-info{background:#f9fbfd;padding:12px;border-radius:12px;margin-bottom:18px;font-size:14px;color:#34495e;}
    .status-label{font-weight:600;color:#1e88e5;}
    .update-section{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .status-select{padding:8px 12px;border:2px solid #e3f2fd;border-radius:10px;font-size:14px;background:white;color:#333;direction:rtl;min-width:160px;}
    .save-btn{padding:8px 18px;background:#1e88e5;color:white;border:none;border-radius:10px;font-weight:600;cursor:pointer;}
    .save-btn:hover{background:#1976d2;}
    .request-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;}
    .request-modal-content{background:white;width:90%;max-width:500px;border-radius:16px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
    .form-group{margin-bottom:20px;}
    .form-control{width:100%;padding:12px;border:2px solid #e3f2fd;border-radius:12px;font-size:15px;direction:rtl;}
    .submit-btn{width:100%;padding:12px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;font-size:16px;cursor:pointer;}
    .submit-btn:hover{background:linear-gradient(to right,#1e88e5,#1565c0);}
    .timer-text{font-weight:700;color:#2e7d32;background:#e8f5e9;padding:6px 12px;border-radius:10px;display:inline-block;margin-top:6px;animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{background-color:#e8f5e9;}50%{background-color:#c8e6c9;}100%{background-color:#e8f5e9;}}

    /* ===== Ø²Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… ÙˆØ§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø© ===== */
    .chatbot-float-btn{
      position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(135deg,#1976d2,#42a5f5);color:#fff;display:flex;align-items:center;justify-content:center;
      box-shadow:0 8px 24px rgba(25,118,210,.35);cursor:pointer;z-index:2000;transition:transform .15s ease, box-shadow .15s ease;
    }
    .chatbot-float-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(25,118,210,.45);}
    .chatbot-float-btn i{font-size:22px;}

    .chatbot-widget{
      position:fixed;bottom:86px;right:20px;width:340px;max-height:520px;background:#fff;border:1px solid #e6eefc;border-radius:16px;
      box-shadow:0 14px 40px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden;z-index:2000;
    }
    .hidden{display:none !important;}
    .cb-header{background:linear-gradient(90deg,#1976d2,#1e88e5);color:#fff;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;}
    .cb-title{display:flex;align-items:center;gap:8px;font-weight:700}
    .cb-title i{opacity:.9}
    .cb-close{background:transparent;border:none;color:#fff;font-size:16px;cursor:pointer}
    .cb-body{padding:10px;height:100%;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#f8fbff}
    .cb-msg{max-width:85%;padding:8px 10px;border-radius:12px;line-height:1.5;font-size:14px;white-space:pre-wrap}
    .cb-msg.user{align-self:flex-end;background:#e3f2fd;border-top-left-radius:4px}
    .cb-msg.bot{align-self:flex-start;background:#ffffff;border:1px solid #ecf2ff;border-top-right-radius:4px}
    .cb-input{padding:8px;border-top:1px solid #e6eefc;background:#fff;display:flex;gap:8px;align-items:flex-end}
    .cb-input textarea{flex:1;resize:none;min-height:40px;max-height:120px;padding:8px;border:2px solid #e6eefc;border-radius:10px;font-size:14px;direction:rtl}
    .cb-send{padding:9px 12px;background:#1976d2;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .cb-send:disabled{opacity:.6;cursor:not-allowed}
    .cb-typing{align-self:flex-start;color:#888;font-size:12px;display:flex;align-items:center;gap:6px}
    .cb-typing .dots{letter-spacing:2px;animation:blink 1.4s infinite}
    @keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}

    /* ğŸ—‚ï¸ ØªØµÙ…ÙŠÙ… Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
.file-viewer-modal {
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);justify-content:center;align-items:center;
  z-index:3000;padding:20px;
}
.file-viewer-content {
  background:white;border-radius:16px;padding:20px;max-width:800px;
  width:100%;max-height:90vh;overflow:auto;position:relative;
  box-shadow:0 10px 30px rgba(0,0,0,0.3);
}
.file-viewer-body {text-align:center;}
.close-btn {
  position:absolute;top:10px;left:15px;font-size:26px;
  cursor:pointer;color:#444;transition:.2s;
}
.close-btn:hover {color:#e53935;}
.view-file-btn {
  background:#1976d2;color:white;border:none;padding:6px 12px;
  border-radius:8px;font-weight:600;cursor:pointer;
}
.view-file-btn:hover {background:#1565c0;}

/* ğŸ¯ Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
#newRequestModal,
#fileViewerModal,
#chatbotWidget {
  display: none;
  opacity: 0;
  pointer-events: none;
}

/* âœ… ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ÙÙ‚Ø· ÙˆÙ‚Øª Ø§Ù„ÙØªØ­ */
#newRequestModal[style*="display: flex"],
#fileViewerModal[style*="display: flex"],
#chatbotWidget:not(.hidden) {
  display: flex !important;
  opacity: 1 !important;
  pointer-events: auto !important;
  z-index: 9999 !important;
}

  </style>
</head>
<body>

  <nav class="navbar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}" alt="Ø´Ø¹Ø§Ø± SEVENS" />
      <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <select id="statusFilter" class="form-control" style="width:200px" onchange="filterRequestsByStatus()">
  <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
  <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
  <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
  <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
  <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚</option>
  <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
  <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
</select>

      <h2 class="page-title" id="pageTitle">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰</h2>
      <button class="new-request-btn" onclick="openNewRequestModal()"><i class="fas fa-plus"></i> Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div class="requests-grid">
  <h3 class="page-title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¥Ù„Ù‰ Ù‚Ø³Ù…Ùƒ</h3>
  <div id="incoming-requests"></div>

  <h3 class="page-title" style="margin-top:30px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§</h3>
  <div id="outgoing-requests"></div>
</div>
</div> <!-- Ø¥ØºÙ„Ø§Ù‚ requests-grid -->


<!-- ğŸ”¹ Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ø·Ù„Ø¨ -->
<div class="request-modal" id="newRequestModal">

  <div class="request-modal-content">
    <h3 class="modal-title">Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <form id="newRequestForm">
      <div class="form-group">
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
        <input type="text" id="requestTitle" class="form-control" required>
      </div>

      <div class="form-group">
        <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
        <textarea id="requestDesc" class="form-control" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
        <select id="targetDept" class="form-control" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>

          <!-- ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
          <optgroup label="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</option>
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          </optgroup>

          <!-- ğŸ’¼ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ø©">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ø©</option>
          </optgroup>

          <!-- ğŸ”§ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª">
            <option value="Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</option>
          </optgroup>

          <!-- ğŸ§¾ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
            <option value="Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          </optgroup>

          <!-- ğŸ§¹ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ø©">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©">Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©</option>
          </optgroup>

          <!-- ğŸ¬ Ø§Ù„ÙØ±ÙˆØ¹ -->
          <optgroup label="Ø§Ù„ÙØ±ÙˆØ¹">
            <option value="Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©">Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©</option>
          </optgroup>
        </select>
      </div>

      <div class="form-group">
  <label>Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
  <input type="file" id="requestFile" class="form-control" accept=".pdf,.jpg,.png,.docx,.xlsx"/>
</div>


      <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
  </div>
</div>

  <!-- Ø²Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… -->
  <div class="chatbot-float-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>


<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª -->
<div id="chatbotWidget" class="chatbot-widget hidden" aria-live="polite">
  <div class="cb-header">
    <div class="cb-title"><i class="fas fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ SEVENS</div>
    <button class="cb-close" onclick="toggleChat(false)" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fas fa-times"></i></button>
  </div>

  <div id="cbBody" class="cb-body"></div>

  <div class="cb-input">
    <textarea id="cbInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
    <button id="cbSend" class="cb-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>
<!-- ğŸ—‚ï¸ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
<div id="fileViewerModal" class="file-viewer-modal" onclick="closeFileViewer(event)">
  <div class="file-viewer-content">
    <span class="close-btn" onclick="closeFileViewer(event)">&times;</span>
    <div id="fileViewerBody" class="file-viewer-body"></div>
  </div>
</div>


<!-- ğŸ”¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
<script>
/* ========== Ø¯Ø§Ù„Ø© ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ========== */
function normalizeArabicJS(t){
  t = (t || '').toString().trim();
  t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§');
  t = t.replace(/\s+/g, '');
  t = t.replace(/Ø©/g, 'Ù‡');
  t = t.replace(/\u200f|\u200e/g, '');
  t = t.replace(/^Ø§Ø¯Ø§Ø±Ù‡?/g, 'Ø§Ø¯Ø§Ø±Ù‡');
  return t;
}

/* ========== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ========== */
let currentUser = null;
let chatHistory = [];
let activeTimers = {};

/* ========== Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª ========== */
/* ğŸ”¹ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ */
function appendMsg(sender, text) {
  const cbBody = document.getElementById("cbBody");
  if (!cbBody) return;
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("cb-msg", sender === "user" ? "user" : "bot");
  msgDiv.textContent = text;
  cbBody.appendChild(msgDiv);
  cbBody.scrollTop = cbBody.scrollHeight;
}

/* ğŸ”¹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
window.onload = async () => {
  console.log("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...");
  let userData = null;
  for (let i = 0; i < 10; i++) {
    userData = localStorage.getItem("currentUser");
    if (userData) break;
    await new Promise(r => setTimeout(r, 300));
  }

  if (!userData) return location.href = "Login.html";
  currentUser = JSON.parse(userData);

  document.getElementById("userWelcome").textContent =
    `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (${currentUser.department})`;
  document.getElementById("pageTitle").textContent =
    `Ù„ÙˆØ­Ø© Ù‚Ø³Ù… ${currentUser.department}`;

  // âœ… Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ù†Ø§
  appendMsg("bot", "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ SEVENSØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ¤–");

  setTimeout(() => loadRequests(), 1000);
};
console.log("ğŸ“¡ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadRequests() ÙØ¹Ù„Ø§Ù‹");

function loadRequests() {
  loadRequestsForUser(currentUser.department);
}


/* ========== ğŸ§© Ø¯Ø§Ù„Ø© ØªÙˆØ­ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø¥ÙƒØ³Ù„ ========== */
function normalizeDepartmentJS(name) {
  if (!name) return '';
  let n = normalizeArabicJS(name).toLowerCase();

  // ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  if (n.includes('Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ø¹Ø§Ù…Ù‡')) return 'Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ø¹Ø§Ù…Ù‡';
  if (n.includes('Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠÙ‡')) return 'Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠÙ‡';
  if (n.includes('Ø§Ù„Ù…Ø§Ù„ÙŠÙ‡')) return 'Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø§Ù„ÙŠÙ‡';
  if (n.includes('Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ù‡')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ù‡';
  if (n.includes('ØªØ­Ù„ÙŠÙ„') || n.includes('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')) return 'Ø§Ø¯Ø§Ø±Ù‡ØªØ­Ù„ÙŠÙ„Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  if (n.includes('Ù…ÙˆØ§Ø±Ø¯') || n.includes('Ø¨Ø´Ø±')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…ÙˆØ§Ø±Ø¯Ø§Ù„Ø¨Ø´Ø±ÙŠÙ‡';
  if (n.includes('ØªÙ‚Ù†ÙŠÙ‡') || n.includes('Ø´Ø¨ÙƒÙ‡')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØªÙ‚Ù†ÙŠÙ‡ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª';
  if (n.includes('ØªØ³ÙˆÙŠÙ‚')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØªØ³ÙˆÙŠÙ‚';
  if (n.includes('ØªØ´ØºÙŠÙ„')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØªØ´ØºÙŠÙ„';
  if (n.includes('ØªØ§Ø¬ÙŠØ±') || n.includes('Ù…ÙƒØªØ¨ØªØ§Ø¬ÙŠØ±')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…ÙƒØªØ¨ØªØ§Ø¬ÙŠØ±';
  if (n.includes('ØµÙŠØ§Ù†') || n.includes('Ù‚Ø·Ø¹')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØµÙŠØ§Ù†Ù‡ÙˆÙ‚Ø·Ø¹Ø§Ù„ØºÙŠØ§Ø±';
  if (n.includes('Ù…Ø¨ÙŠØ¹Ø§Øª') && !n.includes('ØµØ§Ù„Ù‡') && !n.includes('Ù‡Ø§ØªÙÙŠ'))
    return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
  if (n.includes('Ù…Ø®Ø²ÙˆÙ†') || n.includes('Ù…Ø³ØªÙˆØ¯Ø¹')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø®Ø²ÙˆÙ†Ù…Ø³ØªÙˆØ¯Ø¹Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª';
  if (n.includes('Ù…Ø´ØªØ±ÙŠØ§Øª')) return 'Ù‚Ø³Ù…Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';

  // ğŸ’¼ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  if (n.includes('Ù‡Ø§ØªÙÙŠ') || n.includes('Ø§Ù„Ù‡Ø§ØªÙÙŠÙ‡')) {
    if (n.includes('Ø±ÙŠØ§Ø¶')) return 'Ù‚Ø³Ù…Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„Ù‡Ø§ØªÙÙŠÙ‡Ø§Ù„Ø±ÙŠØ§Ø¶';
    return 'Ù‚Ø³Ù…Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„Ù‡Ø§ØªÙÙŠÙ‡';
  }

  if (n.includes('Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡')) {
    if (n.includes('Ù…Ø¯ÙŠÙ†Ù‡')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø§Ù„Ù…Ø¯ÙŠÙ†Ù‡Ù…Ù†ÙˆØ±Ù‡';
    if (n.includes('Ø¬Ø¯Ù‡')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø¬Ø¯Ù‡';
    if (n.includes('Ø±ÙŠØ§Ø¶') && n.includes('1')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø§Ù„Ø±ÙŠØ§Ø¶1';
    if (n.includes('Ø±ÙŠØ§Ø¶') && n.includes('2')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø§Ù„Ø±ÙŠØ§Ø¶2';
    return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡';
  }

  // ğŸ”§ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª
  if (n.includes('Ø§Ø³ØªÙ‚Ø¨Ø§Ù„') && n.includes('ØµÙŠØ§Ù†')) return 'Ù‚Ø³Ù…Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡Ø§Ù„ØµÙŠØ§Ù†Ù‡';
  if (n.includes('Ø®Ø¯Ù…Ù‡') && n.includes('Ø¹Ù…Ù„Ø§Ø¡')) return 'Ù‚Ø³Ù…Ø®Ø¯Ù…Ø¹Ù…Ù„Ø§Ø¡Ø§Ù„ØµÙŠØ§Ù†Ù‡';
  if (n.includes('Ø®Ø¯Ù…Ù‡') && n.includes('ÙÙ†ÙŠ')) return 'Ù‚Ø³Ù…Ø§Ù„Ø®Ø¯Ù…Ø§ØªÙÙ†ÙŠØµÙŠØ§Ù†Ø©';

  // ğŸ§¾ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
  if (n.includes('Ù…Ø®Ø²ÙˆÙ†') && n.includes('Ø³ÙŠØ§Ø±Ø§Øª')) return 'Ù‚Ø³Ù…Ù…Ø®Ø²ÙˆÙ†Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª';

  // ğŸ§¹ Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
  if (n.includes('Ù†Ø¸Ø§Ù') || n.includes('Ø§Ø³ØªÙ‚Ø¨Ø§Ù„')) {
    if (n.includes('Ù…Ø¯ÙŠÙ†Ù‡')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ù…Ø¯ÙŠÙ†Ù‡';
    if (n.includes('Ø¬Ø¯Ù‡')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø¬Ø¯Ù‡';
    if (n.includes('Ø±ÙŠØ§Ø¶1')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ø±ÙŠØ§Ø¶1';
    if (n.includes('Ø±ÙŠØ§Ø¶2')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ø±ÙŠØ§Ø¶2';
    if (n.includes('Ø±ÙŠØ§Ø¶')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ø±ÙŠØ§Ø¶';
    return 'Ù‚Ø³Ù…Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ÙˆØ§Ù„Ù†Ø¸Ø§ÙÙ‡';
  }

  // ğŸ¬ Ø§Ù„ÙØ±ÙˆØ¹
  if (n.includes('ÙØ±Ø¹') && n.includes('Ø¬Ø¯Ù‡')) return 'Ø§Ø¯Ø§Ø±Ù‡ÙØ±Ø¹Ø¬Ø¯Ù‡';

  return n;
}

/* ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
/* ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¨Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„ Ø§Ù„Ø£ÙˆÙ„) ========== */
/* ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ÙÙ„ØªØ±Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) ========== */
async function loadRequestsForUser(dept) {
console.log("ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ù‚Ø³Ù…:", dept);

  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
  document.getElementById('incoming-requests').innerHTML = '<div class="loading-message">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>';
  document.getElementById('outgoing-requests').innerHTML = '';

  try {
  const res = await fetch('/api/get_requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ role: 'Ù…ÙˆØ¸Ù', department: dept })
  });

  const data = await res.json();
  console.log("âœ… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:", data);


    // ğŸ”¹ ÙØµÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ ÙˆØ§Ø±Ø¯Ø© ÙˆØµØ§Ø¯Ø±Ø© Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    const deptStd = normalizeArabicJS(dept);
    const incoming = data.filter(r => {
      const recv = normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']);
      return recv.includes(deptStd) || deptStd.includes(recv);
    });

    const outgoing = data.filter(r => {
      const send = normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']);
      return send.includes(deptStd) || deptStd.includes(send);
    });

    // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø£Ù‚Ø³Ø§Ù…Ù‡Ø§
    renderRequests('incoming-requests', incoming);
    renderRequests('outgoing-requests', outgoing);

  } catch (e) {
    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', e);
    document.getElementById('incoming-requests').innerHTML = '<div class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>';
  }
}



/* ========== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
function renderRequests(containerId, list) {
  const c = document.getElementById(containerId);
  if (!Array.isArray(list) || !list.length) {
    c.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>';
    return;
  }

  c.innerHTML = list.map(req => {
    const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©'] || '').trim();
    const fileName = req['Ø§Ù„Ù…Ù„Ù'] || '';

    return `
      <div class="request-card" data-id="${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || ''}">
        <div class="status-header ${statusToClass(status)}"></div>
        <div class="card-content">
          <div class="card-top">
            <div class="request-id">#${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || ''}</div>
            <div class="request-date">${req['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || ''}</div>
          </div>

          <h3 class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || ''}</h3>
          <p class="request-desc">${req['Ø§Ù„ÙˆØµÙ'] || ''}</p>

          <div class="request-meta">
            <div class="meta-item"><i class="fas fa-user"></i>
              Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'})
            </div>
            <div class="meta-item"><i class="fas fa-user-check"></i>
              Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'})
            </div>
          </div>

          <div class="status-info">
            <div><span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
              <span class="status-badge ${statusToClass(status)}">${status || '-'}</span>
            </div>
            <div><span class="status-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span> ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©'] || '-'}</div>
          </div>

          ${fileName
            ? `<div class="meta-item">
                 <i class="fas fa-paperclip"></i>
                 <button class="view-file-btn" onclick="openFileViewer('/uploads/${fileName}')">
                   Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚
                 </button>
               </div>`
            : `<div class="meta-item"><i class="fas fa-paperclip"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</div>`}
        </div>
      </div>`;
  }).join('');
}

/* ========== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª ========== */
function statusToClass(s) {
  if (s.includes('Ø¬Ø¯ÙŠØ¯')) return 'status-new';
  if (s.includes('Ù…ØºÙ„Ù‚')) return 'status-closed';
  if (s.includes('Ø¬Ø§Ø±ÙŠ')) return 'status-in-progress';
  if (s.includes('Ù…Ø±ÙÙˆØ¶')) return 'status-rejected';
  return 'status-assigned';
}

/* ========== ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ========== */
function filterRequestsByStatus() {
  const status = document.getElementById('statusFilter').value.trim();
  const allCards = document.querySelectorAll('.request-card');
  allCards.forEach(card => {
    const text = card.innerText || '';
    card.style.display = (!status || text.includes(status)) ? 'block' : 'none';
  });
}

/* ========== Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ========== */
document.getElementById('newRequestForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const title = document.getElementById('requestTitle').value.trim();
  const desc  = document.getElementById('requestDesc').value.trim();
  const targetDept = document.getElementById('targetDept').value.trim();
  const fileInput = document.getElementById('requestFile');

  if (!title || !desc || !targetDept) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    return;
  }

  const formData = new FormData();
  formData.append('title', title);
  formData.append('description', desc);
  formData.append('targetDept', targetDept);
  formData.append('senderDept', currentUser.department);
  formData.append('senderName', currentUser.name);
  if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
  }

  try {
    const res = await fetch('/api/create_request', { method: 'POST', body: formData });
    const data = await res.json();

    if (data.success) {
      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
      closeNewRequestModal();
      document.getElementById('newRequestForm').reset();
      await loadRequests(); // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    } else {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (data.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  } catch (e) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', e);
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„.");
  }
});

/* ========== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ========== */
function openFileViewer(url) {
  const viewerBody = document.getElementById('fileViewerBody');
  viewerBody.innerHTML = '';
  const ext = url.split('.').pop().toLowerCase();

  if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
    viewerBody.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:10px;">`;
  } else if (ext === 'pdf') {
    viewerBody.innerHTML = `<iframe src="${url}" width="100%" height="500px" style="border:none;border-radius:10px;"></iframe>`;
  } else if (['xlsx', 'xls', 'docx', 'doc'].includes(ext)) {
    viewerBody.innerHTML = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${window.location.origin + url}" width="100%" height="500px" frameborder="0"></iframe>`;
  } else {
    viewerBody.innerHTML = `<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡ <a href="${url}" target="_blank">Ù…Ù† Ù‡Ù†Ø§</a>.</p>`;
  }

  document.getElementById('fileViewerModal').style.display = 'flex';
}

function closeFileViewer(e) {
  const modal = document.getElementById('fileViewerModal');
  if (e.target === modal || e.target.classList.contains('close-btn')) {
    modal.style.display = 'none';
    document.getElementById('fileViewerBody').innerHTML = '';
  }
}

/* ========== ÙØªØ­ ÙˆØºÙ„Ù‚ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬ ========== */
function openNewRequestModal() {
  const modal = document.getElementById('newRequestModal');
  modal.style.display = 'flex';
  modal.style.opacity = '1';
  modal.style.pointerEvents = 'auto';

  // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨ Ù„Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ ÙØªØ­Ù‡Ø§ Ø¨Ù‚Ù„ÙŠÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ‚Ø§Ø· Ù†Ù‚Ø±Ø© Ø§Ù„Ø²Ø± Ù†ÙØ³Ù‡
  setTimeout(() => {
    document.addEventListener('click', handleOutsideClick);
  }, 200);
}

function closeNewRequestModal() {
  const modal = document.getElementById('newRequestModal');
  modal.style.display = 'none';
  modal.style.opacity = '0';
  modal.style.pointerEvents = 'none';

  // âœ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
  document.removeEventListener('click', handleOutsideClick);
}

// ğŸ”¹ Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
function handleOutsideClick(e) {
  const modal = document.getElementById('newRequestModal');
  const content = modal.querySelector('.request-modal-content');
  const openButton = document.querySelector('.new-request-btn'); // Ø²Ø± Ø§Ù„ÙØªØ­ Ù†ÙØ³Ù‡

  // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ ÙˆÙ„ÙŠØ³ Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
  if (
    modal.style.display === 'flex' &&
    !content.contains(e.target) &&
    e.target !== openButton &&
    !openButton.contains(e.target)
  ) {
    closeNewRequestModal();
  }
}


/* ========== Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ ========== */
function logout() {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
    localStorage.removeItem('currentUser');
    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    window.location.href = 'Login.html';
  }
}


</script>

<style>
.toast{
  position:fixed;bottom:30px;left:50%;
  transform:translateX(-50%);
  padding:12px 25px;border-radius:10px;
  color:#fff;font-size:15px;opacity:0;
  transition:all .4s ease;z-index:9999;
}
.toast.show{opacity:1;bottom:50px;}
.toast.success{background:#4caf50;}
.toast.error{background:#e74c3c;}
.toast.info{background:#3498db;}
.card-glow{border:2px solid #81c784;box-shadow:0 0 15px rgba(129,199,132,0.6);}
</style>

</body>
</html>

