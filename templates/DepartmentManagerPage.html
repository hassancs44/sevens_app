<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… | SEVENS</title>

  <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
  
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Tajawal', sans-serif;
}

body {
  background: #f8fbff;
  color: #2c3e50;
  min-height: 100vh;
}

.navbar {
  background: white;
  padding: 18px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo-box {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo-box img {
  width: 44px;
  height: 44px;
  object-fit: contain;
  border-radius: 10px;
}

.logo-box h1 {
  color: #1e88e5;
  font-size: 22px;
  font-weight: 700;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #34495e;
  font-weight: 600;
}

.logout-btn {
  background: #e3f2fd;
  color: #1976d2;
  border: none;
  padding: 6px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}
.logout-btn:hover {
  background: #bbdefb;
}

.container {
  max-width: 1100px;
  margin: 30px auto;
  padding: 0 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 10px;
}

.page-title {
  font-size: 26px;
  color: #0d47a1;
  font-weight: 700;
}

.section-title {
  font-size: 22px;
  color: #1e88e5;
  margin: 30px 0 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e3f2fd;
  display: flex;
  align-items: center;
  gap: 10px;
}

.new-request-btn {
  padding: 10px 20px;
  background: linear-gradient(to right, #2196f3, #1976d2);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}
.new-request-btn:hover {
  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

.requests-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
  gap: 22px;
  justify-content: center;
}

.request-card {
  background: #fff;
  border-radius: 18px;
  border: 1px solid #e3f2fd;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  text-align: right;
  aspect-ratio: 1 / 1; 
  padding: 18px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.request-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(30, 136, 229, 0.18);
}

.request-title {
  font-size: 17px;
  font-weight: 700;
  color: #0d47a1;
  margin: 8px 0;
  line-height: 1.4;
  height: 45px;
  overflow: hidden;
}

.request-desc {
  font-size: 14px;
  color: #607d8b;
  line-height: 1.6;
  flex-grow: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 10px;
}

.status-info {
  font-size: 13px;
  font-weight: 600;
  color: #555;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f8fbff;
  padding: 6px 10px;
  border-radius: 10px;
}

.view-file-btn {
  padding: 7px 14px;
  border-radius: 10px;
  font-size: 13px;
  background: linear-gradient(90deg, #42a5f5, #1e88e5);
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.25s;
  margin-top: 8px;
  font-weight: 600;
}
.view-file-btn:hover {
  background: linear-gradient(90deg, #1e88e5, #2196f3);
  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.25);
}

.status-header { height: 6px; }
.status-new { background: #2196f3; }
.status-in-progress { background: #ff9800; }
.status-closed { background: #4caf50; }
.status-rejected { background: #f44336; }

.card-content {
  padding: 24px;
}

.request-title {
  font-size: 20px;
  margin-bottom: 12px;
  color: #2c3e50;
  font-weight: 600;
}

.request-desc {
  color: #555;
  margin-bottom: 18px;
  line-height: 1.6;
  font-size: 15px;
}

.status-info {
  background: #f9fbfd;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 18px;
  font-size: 14px;
  color: #34495e;
}

.no-requests {
  text-align: center;
  padding: 30px;
  color: #7f8c8d;
  font-style: italic;
}

.export-section {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.export-btn {
  background: #43a047;
  color: white;
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}
.export-btn:hover {
  background: #388e3c;
}

#statusFilter {
  border: 2px solid #e3f2fd;
  border-radius: 10px;
  padding: 10px;
  background: white;
  color: #0d47a1;
  font-weight: 600;
}
#statusFilter:focus {
  outline: none;
  border-color: #1e88e5;
  box-shadow: 0 0 8px rgba(30, 136, 229, 0.3);
}

.card-glow {
  border: 2px solid #81c784 !important;
  box-shadow: 0 0 18px rgba(129, 199, 132, 0.6) !important;
  transition: all .3s ease-in-out;
}

.chatbot-float-btn {
  position: fixed;
  bottom: 25px;
  left: 25px;
  background: linear-gradient(135deg, #42a5f5, #1e88e5);
  color: white;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 26px;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(30, 136, 229, 0.3);
  z-index: 1000;
}

.chatbot-widget {
  position: fixed;
  bottom: 100px;
  left: 25px;
  width: 350px;
  max-height: 520px;
  background: #fff;
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
  display: none;
  flex-direction: column;
  z-index: 1000;
}
.chatbot-widget.show {
  display: flex;
}

.cb-header {
  background: linear-gradient(135deg, #2196f3, #1565c0);
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cb-body {
  flex: 1;
  overflow-y: auto;
  padding: 14px;
  background: #f8fbff;
}

.cb-msg {
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 80%;
  line-height: 1.6;
  font-size: 14px;
}
.cb-msg.user {
  background: #e3f2fd;
  color: #0d47a1;
  margin-left: auto;
}
.cb-msg.bot {
  background: #e8f5e9;
  color: #2e7d32;
}

.cb-input {
  display: flex;
  border-top: 1px solid #e3f2fd;
}
.cb-input textarea {
  flex: 1;
  border: none;
  padding: 10px;
  font-family: 'Tajawal';
  font-size: 14px;
  resize: none;
}
.cb-send {
  background: #1e88e5;
  color: white;
  border: none;
  padding: 0 16px;
  cursor: pointer;
}
    
.request-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.45);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.request-modal-content {
  background: #fff;
  width: 90%;
  max-width: 500px;
  border-radius: 18px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  position: relative;
  text-align: right;
}

.form-group { margin-bottom: 20px; }

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #e3f2fd;
  border-radius: 12px;
  font-size: 15px;
  direction: rtl;
}

.submit-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(to right, #2196f3, #1976d2);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
}
.submit-btn:hover {
  background: linear-gradient(to right, #1e88e5, #1565c0);
}

.file-viewer-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 3000;
  padding: 20px;
}

.file-viewer-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow: auto;
  position: relative;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.file-viewer-body { text-align: center; }

.close-btn {
  position: absolute;
  top: 10px;
  left: 15px;
  font-size: 26px;
  cursor: pointer;
  color: #444;
  transition: .2s;
}
.close-btn:hover {
  color: #e53935;
}

.view-file-btn {
  background: #1976d2;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}
.view-file-btn:hover {
  background: #1565c0;
}

.chatbot-widget.hidden,
.file-viewer-modal:not([style*="display: flex"]) {
  pointer-events: none !important;
  opacity: 0;
}
.chatbot-widget.hidden {
  display: none !important;
}
.chatbot-widget,
.file-viewer-modal {
  pointer-events: auto;
}

.update-section {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  background: #f9fbfd;
  padding: 10px 12px;
  border-radius: 10px;
}

.status-select {
  padding: 8px 10px;
  border: 2px solid #e3f2fd;
  border-radius: 8px;
  font-weight: 600;
  color: #1e88e5;
  background-color: white;
  cursor: pointer;
  transition: 0.2s;
}
.status-select:hover {
  border-color: #90caf9;
}

.timer-text {
  display: inline-block;
  min-width: 70px;
  padding: 5px 8px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 14px;
  text-align: center;
  color: #333;
  background: #f1f8e9;
  border: 1px solid #c8e6c9;
}

.custom-dropdown {
  position: relative;
  width: 220px;
  font-family: 'Tajawal';
}

.dropdown-selected {
  background: white;
  border: 2px solid #e3f2fd;
  border-radius: 10px;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #0d47a1;
  cursor: pointer;
  transition: 0.25s;
  box-shadow: 0 2px 6px rgba(33, 150, 243, 0.05);
}
.dropdown-selected:hover {
  box-shadow: 0 4px 10px rgba(33, 150, 243, 0.15);
}
.dropdown-selected i {
  font-size: 14px;
  color: #1565c0;
  transition: transform 0.3s ease;
}
.custom-dropdown.active .dropdown-selected i {
  transform: rotate(180deg);
}

.dropdown-list {
  position: absolute;
  top: 100%;
  right: 0;
  left: 0;
  background: white;
  border: 2px solid #e3f2fd;
  border-radius: 10px;
  margin-top: 6px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  display: none;
  flex-direction: column;
  z-index: 999;
  max-height: 250px;
  overflow: hidden;
}
.custom-dropdown.active .dropdown-list {
  display: flex;
}

.dropdown-list input {
  border: none;
  border-bottom: 1px solid #e3f2fd;
  padding: 8px 10px;
  outline: none;
  font-size: 14px;
  color: #1565c0;
}

.dropdown-list div { flex: 1; overflow-y: auto; }

.dropdown-item {
  padding: 10px 12px;
  transition: 0.2s;
  cursor: pointer;
  color: #2c3e50;
}
.dropdown-item:hover {
  background: #e3f2fd;
  color: #0d47a1;
}


.cb-body {
  flex: 1;
  overflow-y: auto;
  padding: 14px;
  background: #f8fbff;
}

.cb-msg {
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 80%;
  line-height: 1.6;
  font-size: 14px;
}

.cb-msg.user {
  background: #e3f2fd;
  color: #0d47a1;
  margin-left: auto;
}

.cb-msg.bot {
  background: #e8f5e9;
  color: #2e7d32;
}

.cb-input {
  display: flex;
  border-top: 1px solid #e3f2fd;
}

.cb-input textarea {
  flex: 1;
  border: none;
  padding: 10px;
  font-family: 'Tajawal';
  font-size: 14px;
  resize: none;
}

.cb-send {
  background: #1e88e5;
  color: white;
  border: none;
  padding: 0 16px;
  cursor: pointer;
}

.chat-msg {
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 14px;
  max-width: 75%;
  word-wrap: break-word;
  position: relative;
  font-size: 14px;
  line-height: 1.6;
  animation: fadeIn 0.4s ease;
}
.chat-msg.me {
  margin-left: auto;
  background: #e3f2fd;
  color: #0d47a1;
  border-top-right-radius: 0;
  box-shadow: 0 3px 6px rgba(33,150,243,0.2);
}
.chat-msg.other {
  margin-right: auto;
  background: #e8f5e9;
  color: #1b5e20;
  border-top-left-radius: 0;
  box-shadow: 0 3px 6px rgba(76,175,80,0.2);
}
.chat-meta {
  font-size: 12px;
  color: #607d8b;
  margin-bottom: 4px;
  display: flex;
  justify-content: space-between;
}
.chat-attachment a {
  color: #1565c0;
  font-weight: 600;
  text-decoration: none;
}
.chat-attachment a:hover {
  text-decoration: underline;
}
@keyframes fadeIn {
  from {opacity:0;transform:translateY(5px);}
  to {opacity:1;transform:translateY(0);}
}

  </style>
</head>

<body>
 
  <nav class="navbar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}" alt="Ø´Ø¹Ø§Ø± SEVENS">
      <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2 class="page-title" id="pageTitle">Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</h2>

      <div class="export-section">
        <select id="statusFilter" onchange="filterRequestsByStatus()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
          <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
          <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
        </select>
<div class="custom-dropdown" id="deptDropdown">
    <div class="dropdown-selected" onclick="toggleDeptDropdown()">
      <span id="deptSelectedText">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="dropdown-list" id="deptList">
      <input type="text" id="deptSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…..." onkeyup="filterDeptList()"/>
      <div id="deptOptions"></div>
    </div>
  </div>
        <button class="export-btn" style="background:#1e88e5" onclick="loadRequests()">
          <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
        </button>

        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button class="export-btn" onclick="exportRequests()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="new-request-btn" onclick="openNewRequestModal()"><i class="fas fa-plus"></i> Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </div>

    <h3 class="section-title"><i class="fas fa-download"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
    <div class="requests-grid" id="incoming-requests"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

    <h3 class="section-title"><i class="fas fa-upload"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>
    <div class="requests-grid" id="outgoing-requests"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>

  <div class="request-modal" id="newRequestModal">
    <div class="request-modal-content">
      <h3>Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="newRequestForm">
        <div class="form-group">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="requestTitle" class="form-control" required />
        </div>
        <div class="form-group">
          <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
          <textarea id="requestDesc" class="form-control" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
        <select id="targetDept" class="form-control" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>

          <optgroup label="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</option>
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          </optgroup>

          <!-- ğŸ’¼ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ø©">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ø©</option>
          </optgroup>

          <!-- ğŸ”§ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª">
            <option value="Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</option>
          </optgroup>

          <!-- ğŸ§¾ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
            <option value="Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          </optgroup>

          <!-- ğŸ§¹ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ø©">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©">Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©</option>
          </optgroup>

          <!-- ğŸ¬ Ø§Ù„ÙØ±ÙˆØ¹ -->
          <optgroup label="Ø§Ù„ÙØ±ÙˆØ¹">
            <option value="Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©">Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©</option>
          </optgroup>
          </select>
        </div>

        <div class="form-group">
  <label>Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
  <input type="file" id="requestFile" class="form-control" accept=".pdf,.jpg,.png,.docx,.xlsx"/>
</div>
        <button type="submit" class="submit-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </form>
    </div>
  </div>

  <div class="chatbot-float-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>


<div id="chatbotWidget" class="chatbot-widget hidden" aria-live="polite">
  <div class="cb-header">
    <div class="cb-title"><i class="fas fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ SEVENS</div>
    <button class="cb-close" onclick="toggleChat(false)" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fas fa-times"></i></button>
  </div>

  <div id="cbBody" class="cb-body"></div>

  <div class="cb-input">
    <textarea id="cbInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
    <button id="cbSend" class="cb-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<div id="ticketDetailsModal" class="file-viewer-modal" onclick="closeTicketDetails(event)">
  <div class="file-viewer-content" style="max-width:900px;">
    <span class="close-btn" onclick="closeTicketDetails(event)">&times;</span>
    <div id="ticketDetailsBody" class="file-viewer-body">
      <h3 id="ticketTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div id="ticketInfo"></div>

      <div id="chatSection" style="margin-top:25px;">
        <h4 style="color:#1565c0;margin-bottom:12px;"><i class="fas fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>

        <div id="chatMessages" style="
            max-height:400px;
            overflow-y:auto;
            background:linear-gradient(180deg,#f8fbff,#e3f2fd);
            border-radius:14px;
            padding:14px;
            border:1px solid #bbdefb;
            box-shadow:inset 0 0 10px rgba(0,0,0,0.05);
          ">
          <div class="loading" style="text-align:center;color:#78909c;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
        </div>

        <div id="chatInputArea" style="margin-top:14px;display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <textarea id="chatInput" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ Ø±Ø³Ø§Ù„ØªÙƒ..." style="flex:1;border-radius:12px;border:2px solid #e3f2fd;padding:10px;font-size:15px;height:70px;"></textarea>
            <input type="file" id="chatAttachment" accept=".pdf,.jpg,.png,.docx,.xlsx" style="display:none;">
            <button onclick="document.getElementById('chatAttachment').click()" class="view-file-btn" style="height:45px;">
              <i class="fas fa-paperclip"></i>
            </button>
            <button onclick="sendChatMessage()" class="save-btn" style="height:45px;">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>
          <small id="selectedFileLabel" style="color:#1565c0;font-weight:600;"></small>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="fileViewerModal" class="file-viewer-modal" onclick="closeFileViewer(event)">
  <div class="file-viewer-content">
    <span class="close-btn" onclick="closeFileViewer(event)">&times;</span>
    <div id="fileViewerBody" class="file-viewer-body"></div>
  </div>
</div>

<script>
function normalizeArabicJS(t){
  t = (t || '').toString().trim();
  t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§');
  t = t.replace(/\s+/g, '');
  t = t.replace(/Ø©/g, 'Ù‡');
  t = t.replace(/\u200f|\u200e/g, '');
  t = t.replace(/^Ø§Ø¯Ø§Ø±Ù‡?/g, 'Ø§Ø¯Ø§Ø±Ù‡');
  return t;
}

let currentUser = null;
let chatHistory = [];
let activeTimers = {};
let allEmployees = [];


function appendMsg(sender, text) {
  const cbBody = document.getElementById("cbBody");
  if (!cbBody) return;
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("cb-msg", sender === "user" ? "user" : "bot");
  msgDiv.textContent = text;
  cbBody.appendChild(msgDiv);
  cbBody.scrollTop = cbBody.scrollHeight;
}

window.onload = async () => {
  console.log("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...");
  let userData = null;
  for (let i = 0; i < 10; i++) {
    userData = localStorage.getItem("currentUser");
    if (userData) break;
    await new Promise(r => setTimeout(r, 300));
  }

  if (!userData) return location.href = "Login.html";
  currentUser = JSON.parse(userData);

  document.getElementById("userWelcome").textContent =
    `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (${currentUser.department})`;
  document.getElementById("pageTitle").textContent =
    `Ù„ÙˆØ­Ø© Ù‚Ø³Ù… ${currentUser.department}`;

  
  appendMsg("bot", "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ SEVENSØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ¤–");

 
  try {
    const res = await fetch('/api/get_employees', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ manager_name: currentUser.name, department: currentUser.department })
});

    const data = await res.json();
    if (data.success) {
      allEmployees = data.employees;
      console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:", allEmployees.length);
    } else {
      console.warn("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:", data.message);
    }
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:", err);
  }


  setTimeout(() => loadRequests(), 1000);
};
console.log("ğŸ“¡ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadRequests() ÙØ¹Ù„Ø§Ù‹");

function loadRequests() {
  loadRequestsForUser(currentUser.department);
}

setInterval(async () => {
  const modal = document.getElementById('newRequestModal');
  const isModalOpen = modal && modal.style.display === 'flex';
  const fileViewer = document.getElementById('fileViewerModal');
  const isFileOpen = fileViewer && fileViewer.style.display === 'flex';

  if (isModalOpen || isFileOpen) {
    console.log("â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù†Ø§ÙØ°Ø© Ø£Ø®Ø±Ù‰");
    return;
  }

  console.log("ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ÙˆØ§Ù„Ù…Ø±Ø³Ù„Ø© ÙÙ‚Ø·...");
  try {
    const res = await fetch('/api/get_requests', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role: 'Ù…ÙˆØ¸Ù', department: currentUser.department })
    });

    const data = await res.json();
    console.log("âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", data.length);

    const deptStd = normalizeArabicJS(currentUser.department);
    const incoming = data.filter(r => normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']).includes(deptStd));
    const outgoing = data.filter(r => normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']).includes(deptStd));

    renderRequests('incoming-requests', incoming);
    renderRequests('outgoing-requests', outgoing);

    showToast("ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ÙˆØ§Ù„Ù…Ø±Ø³Ù„Ø© âœ…", "info");
  } catch (err) {
    console.error("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", err);
  }
}, 30000);

function normalizeDepartmentJS(name) {
  if (!name) return '';
  let n = normalizeArabicJS(name).toLowerCase();

  // ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  if (n.includes('Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ø¹Ø§Ù…Ù‡')) return 'Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ø¹Ø§Ù…Ù‡';
  if (n.includes('Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠÙ‡')) return 'Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠÙ‡';
  if (n.includes('Ø§Ù„Ù…Ø§Ù„ÙŠÙ‡')) return 'Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø§Ù„ÙŠÙ‡';
  if (n.includes('Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ù‡')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ù‡';
  if (n.includes('ØªØ­Ù„ÙŠÙ„') || n.includes('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')) return 'Ø§Ø¯Ø§Ø±Ù‡ØªØ­Ù„ÙŠÙ„Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  if (n.includes('Ù…ÙˆØ§Ø±Ø¯') || n.includes('Ø¨Ø´Ø±')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…ÙˆØ§Ø±Ø¯Ø§Ù„Ø¨Ø´Ø±ÙŠÙ‡';
  if (n.includes('ØªÙ‚Ù†ÙŠÙ‡') || n.includes('Ø´Ø¨ÙƒÙ‡')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØªÙ‚Ù†ÙŠÙ‡ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª';
  if (n.includes('ØªØ³ÙˆÙŠÙ‚')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØªØ³ÙˆÙŠÙ‚';
  if (n.includes('ØªØ´ØºÙŠÙ„')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØªØ´ØºÙŠÙ„';
  if (n.includes('ØªØ§Ø¬ÙŠØ±') || n.includes('Ù…ÙƒØªØ¨ØªØ§Ø¬ÙŠØ±')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…ÙƒØªØ¨ØªØ§Ø¬ÙŠØ±';
  if (n.includes('ØµÙŠØ§Ù†') || n.includes('Ù‚Ø·Ø¹')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„ØµÙŠØ§Ù†Ù‡ÙˆÙ‚Ø·Ø¹Ø§Ù„ØºÙŠØ§Ø±';
  if (n.includes('Ù…Ø¨ÙŠØ¹Ø§Øª') && !n.includes('ØµØ§Ù„Ù‡') && !n.includes('Ù‡Ø§ØªÙÙŠ'))
    return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª';
  if (n.includes('Ù…Ø®Ø²ÙˆÙ†') || n.includes('Ù…Ø³ØªÙˆØ¯Ø¹')) return 'Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…Ø®Ø²ÙˆÙ†Ù…Ø³ØªÙˆØ¯Ø¹Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª';
  if (n.includes('Ù…Ø´ØªØ±ÙŠØ§Øª')) return 'Ù‚Ø³Ù…Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';

  // ğŸ’¼ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  if (n.includes('Ù‡Ø§ØªÙÙŠ') || n.includes('Ø§Ù„Ù‡Ø§ØªÙÙŠÙ‡')) {
    if (n.includes('Ø±ÙŠØ§Ø¶')) return 'Ù‚Ø³Ù…Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„Ù‡Ø§ØªÙÙŠÙ‡Ø§Ù„Ø±ÙŠØ§Ø¶';
    return 'Ù‚Ø³Ù…Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„Ù‡Ø§ØªÙÙŠÙ‡';
  }

  if (n.includes('Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡')) {
    if (n.includes('Ù…Ø¯ÙŠÙ†Ù‡')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø§Ù„Ù…Ø¯ÙŠÙ†Ù‡Ù…Ù†ÙˆØ±Ù‡';
    if (n.includes('Ø¬Ø¯Ù‡')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø¬Ø¯Ù‡';
    if (n.includes('Ø±ÙŠØ§Ø¶') && n.includes('1')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø§Ù„Ø±ÙŠØ§Ø¶1';
    if (n.includes('Ø±ÙŠØ§Ø¶') && n.includes('2')) return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡Ø§Ù„Ø±ÙŠØ§Ø¶2';
    return 'Ù‚Ø³Ù…Ù…Ø¨ÙŠØ¹Ø§ØªØ§Ù„ØµØ§Ù„Ù‡';
  }

  // ğŸ”§ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª
  if (n.includes('Ø§Ø³ØªÙ‚Ø¨Ø§Ù„') && n.includes('ØµÙŠØ§Ù†')) return 'Ù‚Ø³Ù…Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡Ø§Ù„ØµÙŠØ§Ù†Ù‡';
  if (n.includes('Ø®Ø¯Ù…Ù‡') && n.includes('Ø¹Ù…Ù„Ø§Ø¡')) return 'Ù‚Ø³Ù…Ø®Ø¯Ù…Ø¹Ù…Ù„Ø§Ø¡Ø§Ù„ØµÙŠØ§Ù†Ù‡';
  if (n.includes('Ø®Ø¯Ù…Ù‡') && n.includes('ÙÙ†ÙŠ')) return 'Ù‚Ø³Ù…Ø§Ù„Ø®Ø¯Ù…Ø§ØªÙÙ†ÙŠØµÙŠØ§Ù†Ø©';

  // ğŸ§¾ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
  if (n.includes('Ù…Ø®Ø²ÙˆÙ†') && n.includes('Ø³ÙŠØ§Ø±Ø§Øª')) return 'Ù‚Ø³Ù…Ù…Ø®Ø²ÙˆÙ†Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª';

  // ğŸ§¹ Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
  if (n.includes('Ù†Ø¸Ø§Ù') || n.includes('Ø§Ø³ØªÙ‚Ø¨Ø§Ù„')) {
    if (n.includes('Ù…Ø¯ÙŠÙ†Ù‡')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ù…Ø¯ÙŠÙ†Ù‡';
    if (n.includes('Ø¬Ø¯Ù‡')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø¬Ø¯Ù‡';
    if (n.includes('Ø±ÙŠØ§Ø¶1')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ø±ÙŠØ§Ø¶1';
    if (n.includes('Ø±ÙŠØ§Ø¶2')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ø±ÙŠØ§Ø¶2';
    if (n.includes('Ø±ÙŠØ§Ø¶')) return 'Ù‚Ø³Ù…Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ø§Ù„Ø±ÙŠØ§Ø¶';
    return 'Ù‚Ø³Ù…Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ÙˆØ§Ù„Ù†Ø¸Ø§ÙÙ‡';
  }

  // ğŸ¬ Ø§Ù„ÙØ±ÙˆØ¹
  if (n.includes('ÙØ±Ø¹') && n.includes('Ø¬Ø¯Ù‡')) return 'Ø§Ø¯Ø§Ø±Ù‡ÙØ±Ø¹Ø¬Ø¯Ù‡';

  return n;
}


async function loadRequestsForUser(dept) {
console.log("ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ù‚Ø³Ù…:", dept);

  document.getElementById('incoming-requests').innerHTML = '<div class="loading-message">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>';
  document.getElementById('outgoing-requests').innerHTML = '';

  try {
  const res = await fetch('/api/get_requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ role: 'Ù…ÙˆØ¸Ù', department: dept })
  });

  const data = await res.json();
  console.log("âœ… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:", data);


    const deptStd = normalizeArabicJS(dept);
    const incoming = data.filter(r => {
      const recv = normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']);
      return recv.includes(deptStd) || deptStd.includes(recv);
    });

    const outgoing = data.filter(r => {
      const send = normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']);
      return send.includes(deptStd) || deptStd.includes(send);
    });

    renderRequests('incoming-requests', incoming);
    renderRequests('outgoing-requests', outgoing);

  } catch (e) {
    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', e);
    document.getElementById('incoming-requests').innerHTML = '<div class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>';
  }
}

function renderRequests(containerId, list) {
  const c = document.getElementById(containerId);
  if (!Array.isArray(list) || !list.length) {
    c.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>';
    return;
  }

  c.innerHTML = list.map(req => {
    const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©'] || '').trim();
    const fileName = req['Ø§Ù„Ù…Ù„Ù'] || '';

    return `
      <div class="request-card" data-id="${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || ''}">
        <div class="status-header ${statusToClass(status)}"></div>
        <div class="card-content">
          <div class="card-top">
            <div class="request-id">#${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || ''}</div>
            <div class="request-date">${req['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || ''}</div>
          </div>

          <h3 class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || ''}</h3>
          <p class="request-desc">${req['Ø§Ù„ÙˆØµÙ'] || ''}</p>

          <div class="request-meta">
            <div class="meta-item"><i class="fas fa-user"></i>
              Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'})
            </div>
            <div class="meta-item"><i class="fas fa-user-check"></i>
              Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'})
            </div>
          </div>

          <div class="status-info">
            <div><span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
              <span class="status-badge ${statusToClass(status)}">${status || '-'}</span>
            </div>
            <div><span class="status-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span> ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©'] || '-'}</div>
          </div>

          ${fileName
            ? `<div class="meta-item">
                 <i class="fas fa-paperclip"></i>
                 <button class="view-file-btn" onclick="event.stopPropagation(); openFileViewer('/uploads/${fileName}')">
  Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚
</button>
               </div>`
            : `<div class="meta-item"><i class="fas fa-paperclip"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</div>`}

           <div class="update-section">
  ${
    
    normalizeArabicJS(req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']) === normalizeArabicJS(currentUser.department)
      ? `
        <select class="status-select" onclick="event.stopPropagation()" onchange="updateRequestStatus('${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}', this.value)">
          <option value="">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
          <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
          <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚</option>
          <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
        </select>
      `
      : `
        <select class="status-select" disabled>
          <option value="">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</option>
        </select>
      `
  }
  <span id="timer-${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}" class="timer-text">${req['Ø§Ù„ÙˆÙ‚Øª'] || '00:00:00'}</span>
</div>
${
  
  currentUser.role === "Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…"
    ? `
      <div class="delegate-section" style="margin-top:10px;">
        <select class="form-control delegate-select" onclick="event.stopPropagation()" onchange="delegateRequest('${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}', this.value)">
          <option value="">ØªÙˆÙƒÙŠÙ„ Ø¥Ù„Ù‰...</option>
          ${allEmployees
            .filter(emp =>
              normalizeArabicJS(emp['Ø§Ù„Ù‚Ø³Ù…']) === normalizeArabicJS(currentUser.department) &&
              emp['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©'] === 'Ù…ÙˆØ¸Ù'
            )
            .map(emp => `<option value="${emp['Ø§Ù„Ø§Ø³Ù…']}">${emp['Ø§Ù„Ø§Ø³Ù…']}</option>`)
            .join('')}
        </select>
      </div>
    `
    : ''
}

        </div>
      </div>`;
    }).join('');

   document.querySelectorAll('.request-card').forEach(c => {
  c.onclick = () => openTicketDetails(c.dataset.id);
});


  setTimeout(() => {
    list.forEach(req => {
      const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©'] || '').trim();
      const timeStr = (req['Ø§Ù„ÙˆÙ‚Øª'] || '00:00:00').trim();
      const [h, m, s] = timeStr.split(':').map(Number);
      const totalSec = (h || 0) * 3600 + (m || 0) * 60 + (s || 0);

      if (status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°') startTimer(req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'], totalSec);
      else if (status === 'Ù…Ø¹Ù„Ù‚') pauseTimer(req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']);
    });
   }, 300);
}


function statusToClass(s) {
  if (s.includes('Ø¬Ø¯ÙŠØ¯')) return 'status-new';
  if (s.includes('Ù…ØºÙ„Ù‚')) return 'status-closed';
  if (s.includes('Ø¬Ø§Ø±ÙŠ')) return 'status-in-progress';
  if (s.includes('Ù…Ø±ÙÙˆØ¶')) return 'status-rejected';
  return 'status-assigned';
}


function filterRequestsByStatus() {
  const status = document.getElementById('statusFilter').value.trim();
  const allCards = document.querySelectorAll('.request-card');

  allCards.forEach(card => {
    
    const badge = card.querySelector('.status-badge');
    const cardStatus = badge ? badge.textContent.trim() : '';

    if (!status) {
      card.style.display = 'block';
      return;
    }

    if (normalizeArabicJS(cardStatus) === normalizeArabicJS(status)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}


async function updateRequestStatus(reqId, newStatus) {
  if (event) event.stopPropagation(); 
  if (!newStatus) return;

  const updater = currentUser.name;
  const payload = { requestId: reqId, status: newStatus, updater };

 
  if (newStatus === "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°") {
    startTimer(reqId);
  }

  if (newStatus === "Ù…Ø¹Ù„Ù‚") {
    pauseTimer(reqId); 
  }

  if (newStatus === "Ù…ØºÙ„Ù‚") {
    const duration = stopTimer(reqId);
    payload.duration = duration;
  }

  try {
    const res = await fetch('/api/update_request_status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
      showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…", "success");
      await loadRequests();
    } else {
      showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« âŒ", "error");
    }
  } catch (e) {
    console.error(e);
    showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
  }
}

let timers = {};
let savedTimes = {}; 

function startTimer(reqId, baseSeconds = null) {
  const el = document.getElementById(`timer-${reqId}`);
  if (!el) return;

  let seconds = savedTimes[reqId] ?? baseSeconds ?? 0;

  clearInterval(timers[reqId]);
  timers[reqId] = setInterval(() => {
    seconds++;
    savedTimes[reqId] = seconds; 
    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    el.textContent = `${h}:${m}:${s}`;

    if (seconds < 300) el.style.background = '#e8f5e9'; 
    else if (seconds < 1800) el.style.background = '#fff8e1'; 
    else el.style.background = '#ffebee';
  }, 1000);
}

function pauseTimer(reqId) {
  if (timers[reqId]) {
    clearInterval(timers[reqId]);
    timers[reqId] = null;
  }
}

function stopTimer(reqId) {
  if (timers[reqId]) {
    clearInterval(timers[reqId]);
    delete timers[reqId];
  }
  const el = document.getElementById(`timer-${reqId}`);
  const time = el ? el.textContent : "00:00:00";

 
  delete savedTimes[reqId];

  return time;
}


function showToast(msg, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast show ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}


document.getElementById('newRequestForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const title = document.getElementById('requestTitle').value.trim();
  const desc  = document.getElementById('requestDesc').value.trim();
  const targetDept = document.getElementById('targetDept').value.trim();
  const fileInput = document.getElementById('requestFile');

  if (!title || !desc || !targetDept) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    return;
  }

  const formData = new FormData();
  formData.append('title', title);
  formData.append('description', desc);
  formData.append('targetDept', targetDept);
  formData.append('senderDept', currentUser.department);
  formData.append('senderName', currentUser.name);
  if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
  }

  try {
    const res = await fetch('/api/create_request', { method: 'POST', body: formData });
    const data = await res.json();

    if (data.success) {
      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
      closeNewRequestModal();
      document.getElementById('newRequestForm').reset();
      await loadRequests(); 
    } else {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (data.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }
  } catch (e) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', e);
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„.");
  }
});
  
function openFileViewer(url) {
  const viewerBody = document.getElementById('fileViewerBody');
  viewerBody.innerHTML = '';
  const ext = url.split('.').pop().toLowerCase();

  if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
    viewerBody.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:10px;">`;
  } else if (ext === 'pdf') {
    viewerBody.innerHTML = `<iframe src="${url}" width="100%" height="500px" style="border:none;border-radius:10px;"></iframe>`;
  } else if (['xlsx', 'xls', 'docx', 'doc'].includes(ext)) {
    viewerBody.innerHTML = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${window.location.origin + url}" width="100%" height="500px" frameborder="0"></iframe>`;
  } else {
    viewerBody.innerHTML = `<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡ <a href="${url}" target="_blank">Ù…Ù† Ù‡Ù†Ø§</a>.</p>`;
  }

  document.getElementById('fileViewerModal').style.display = 'flex';
}

function closeFileViewer(e) {
  const modal = document.getElementById('fileViewerModal');
  if (e.target === modal || e.target.classList.contains('close-btn')) {
    modal.style.display = 'none';
    document.getElementById('fileViewerBody').innerHTML = '';
  }
}

function openNewRequestModal() {
  const modal = document.getElementById('newRequestModal');
  modal.style.display = 'flex';
  modal.style.opacity = '1';
  modal.style.pointerEvents = 'auto';

  setTimeout(() => {
    document.addEventListener('click', handleOutsideClick);
  }, 200);
}

function closeNewRequestModal() {
  const modal = document.getElementById('newRequestModal');
  modal.style.display = 'none';
  modal.style.opacity = '0';
  modal.style.pointerEvents = 'none';

  document.removeEventListener('click', handleOutsideClick);
}

function handleOutsideClick(e) {
  const modal = document.getElementById('newRequestModal');
  const content = modal.querySelector('.request-modal-content');
  const openButton = document.querySelector('.new-request-btn'); 

  if (
    modal.style.display === 'flex' &&
    !content.contains(e.target) &&
    e.target !== openButton &&
    !openButton.contains(e.target)
  ) {
    closeNewRequestModal();
  }
}


function logout() {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
    localStorage.removeItem('currentUser');
    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    window.location.href = 'Login.html';
  }
}

async function exportRequests() {
  const start = document.getElementById('startDate').value || null;
  const end = document.getElementById('endDate').value || null;

  const res = await fetch('/api/export_requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      department: currentUser.department,
      start_date: start,
      end_date: end
    })
  });

  const data = await res.json();
  if (data.success && data.file)
    window.location.href = `/download/${data.file}`;
  else
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
}

async function delegateRequest(reqId, delegateName) {
  if (!delegateName) return;
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${reqId} Ø¥Ù„Ù‰ ${delegateName}ØŸ`)) return;

  try {
    const res = await fetch('/api/delegate_request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        requestId: reqId,
        delegate: delegateName,
        delegatedBy: currentUser.name
      })
    });

    const data = await res.json();
    if (data.success) {
      showToast(`ØªÙ… ØªÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${delegateName} âœ…`, "success");
      await loadRequests();
    } else {
      showToast("âŒ ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙˆÙƒÙŠÙ„", "error");
    }
  } catch (e) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙŠÙ„:', e);
    showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
  }
}
  
const departments = [
  "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©",
  "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©",
  "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
  "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
  "Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„",
  "Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±",
  "Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª",
  "Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©",
  "Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
  "Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©",
  "Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1",
  "Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2",
  "Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©",
  "Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶",
  "Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ù‡",
  "Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
  "Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1",
  "Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2",
  "Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶",
  "Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ù‡",
  "Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©",
  "Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª",
  "Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©"
];

const deptContainer = document.getElementById('deptOptions');

const allOption = document.createElement('div');
allOption.className = 'dropdown-item all-depts';
allOption.textContent = " Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…";
allOption.onclick = () => selectDept("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…");
deptContainer.appendChild(allOption);

departments.forEach(dep => {
  const div = document.createElement('div');
  div.className = 'dropdown-item';
  div.textContent = dep;
  div.onclick = () => selectDept(dep);
  deptContainer.appendChild(div);
});

function toggleDeptDropdown() {
  document.getElementById('deptDropdown').classList.toggle('active');
}

function selectDept(name) {
  document.getElementById('deptSelectedText').textContent = name || "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…";
  document.getElementById('deptDropdown').classList.remove('active');
  filterRequests();
}

function filterDeptList() {
  const input = document.getElementById("deptSearch").value.toLowerCase();
  const items = document.querySelectorAll(".dropdown-item");
  items.forEach(i => {
    i.style.display = i.textContent.toLowerCase().includes(input) ? "block" : "none";
  });

  document.querySelector(".all-depts").style.display = "block";
}

window.addEventListener('click', (e) => {
  const dropdown = document.getElementById('deptDropdown');
  if (!dropdown.contains(e.target)) dropdown.classList.remove('active');
});

function filterRequests() {
  const status = document.getElementById("statusFilter").value.trim();
  const dept = document.getElementById("deptSelectedText").textContent.trim();
  const allCards = document.querySelectorAll(".request-card");

  if (dept === "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…" || !dept) {
    allCards.forEach(card => {
      const text = card.innerText || "";
      const matchStatus = !status || text.includes(status);
      card.style.display = matchStatus ? "block" : "none";
    });
    document.getElementById("pageTitle").textContent = dept === "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"
  ? "Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…"
  : `Ø·Ù„Ø¨Ø§Øª Ù‚Ø³Ù… ${dept}`;

    return;
  }

  const normalizedDept = normalizeArabicJS(dept);
  allCards.forEach(card => {
    const text = normalizeArabicJS(card.innerText || "");
    const matchDept =
      text.includes(normalizedDept) || text.includes(dept.replace(/\s/g, ""));
    const matchStatus = !status || text.includes(status);

    card.style.display = (matchDept && matchStatus) ? "block" : "none";
  });

  document.getElementById("pageTitle").textContent = `Ø·Ù„Ø¨Ø§Øª Ù‚Ø³Ù… ${dept}`;
}

async function openTicketDetails(reqId) {
  try {
    
    const res = await fetch('/api/get_requests', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({role: currentUser.role, department: currentUser.department})
    });
    const data = await res.json();
    const ticket = data.find(r => r['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] === reqId);
    if (!ticket) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨.');

    document.getElementById('ticketTitle').textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${reqId}`;
    document.getElementById('ticketInfo').innerHTML = `
      <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${ticket['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || ''}</p>
      <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${ticket['Ø§Ù„ÙˆØµÙ'] || ''}</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || ''}</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> ${ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || ''}</p>
      <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${ticket['Ø§Ù„Ø­Ø§Ù„Ø©'] || ''}</p>
    `;

    
    loadChatMessages(reqId);

    document.getElementById('ticketDetailsModal').style.display = 'flex';
    document.getElementById('ticketDetailsModal').dataset.reqid = reqId;
  } catch (e) {
    console.error(e);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„.');
  }
}

function closeTicketDetails(e) {
  const modal = document.getElementById('ticketDetailsModal');
  if (e.target === modal || e.target.classList.contains('close-btn')) {
    modal.style.display = 'none';
    document.getElementById('chatMessages').innerHTML = '';
  }
}


async function loadChatMessages(reqId) {
  try {
    const res = await fetch(`/api/chat_get/${reqId}`);
    const msgs = await res.json();
    const box = document.getElementById('chatMessages');
    if (!Array.isArray(msgs) || msgs.length === 0) {
      box.innerHTML = '<div style="text-align:center;color:#78909c;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯ ğŸ’¬</div>';
      return;
    }

    box.innerHTML = msgs.map(m => `
      <div class="chat-msg ${normalizeArabicJS(m['Ø§Ù„Ù‚Ø³Ù…']) === normalizeArabicJS(currentUser.department) ? 'me' : 'other'}">
        <div class="chat-meta">
          <strong>${m['Ø§Ù„Ù…Ø±Ø³Ù„']}</strong>
          <span class="chat-time">${m['Ø§Ù„ÙˆÙ‚Øª']}</span>
        </div>
        <div class="chat-text">${m['Ø§Ù„Ø±Ø³Ø§Ù„Ø©'] || ''}</div>
        ${m['Ø§Ù„Ù…Ù„Ù'] ? `
          <div class="chat-attachment">
            <a href="/chat_uploads/${m['Ø§Ù„Ù…Ù„Ù']}" target="_blank">
              <i class="fas fa-paperclip"></i> ${m['Ø§Ù„Ù…Ù„Ù']}
            </a>
          </div>` : ''}
      </div>
    `).join('');

    box.scrollTop = box.scrollHeight;
  } catch (e) {
    console.error("loadChatMessages error:", e);
  }
}

async function sendChatMessage() {
  const reqId = document.getElementById('ticketDetailsModal').dataset.reqid;
  const msg = document.getElementById('chatInput').value.trim();
  const fileInput = document.getElementById('chatAttachment');
  if (!msg && fileInput.files.length === 0) return;

  const formData = new FormData();
  formData.append('request_id', reqId);
  formData.append('sender', currentUser.name);
  formData.append('department', currentUser.department);
  formData.append('message', msg);

  if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
  }

  try {
    const res = await fetch('/api/chat_send_file', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();
    if (data.success) {
      document.getElementById('chatInput').value = '';
      document.getElementById('chatAttachment').value = '';
      document.getElementById('selectedFileLabel').textContent = '';
      await loadChatMessages(reqId);
    } else {
      alert('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
    }
  } catch (e) {
    console.error(e);
  }
}

setInterval(() => {
  const modal = document.getElementById('ticketDetailsModal');
  if (modal && modal.style.display === 'flex') {
    const reqId = modal.dataset.reqid;
    loadChatMessages(reqId);
  }
}, 10000);

document.getElementById('chatAttachment').addEventListener('change', e => {
  const file = e.target.files[0];
  const label = document.getElementById('selectedFileLabel');
  label.textContent = file ? `ğŸ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name}` : '';
});


</script>

<style>
.toast{
  position:fixed;bottom:30px;left:50%;
  transform:translateX(-50%);
  padding:12px 25px;border-radius:10px;
  color:#fff;font-size:15px;opacity:0;
  transition:all .4s ease;z-index:9999;
}
.toast.show{opacity:1;bottom:50px;}
.toast.success{background:#4caf50;}
.toast.error{background:#e74c3c;}
.toast.info{background:#3498db;}
.card-glow{border:2px solid #81c784;box-shadow:0 0 15px rgba(129,199,132,0.6);}
</style>
</body>
</html>


