<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… | SEVENS</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
    body{background:#f8fbff;color:#2c3e50;min-height:100vh;}
    .navbar{background:white;padding:18px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 12px rgba(0,0,0,0.06);position:sticky;top:0;z-index:100;}
    .logo-box{display:flex;align-items:center;gap:14px;}
    .logo-box img{width:44px;height:44px;object-fit:contain;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .logo-box h1{color:#1e88e5;font-size:22px;font-weight:700;}
    .user-info{display:flex;align-items:center;gap:12px;color:#34495e;font-weight:600;}
    .logout-btn{background:#e3f2fd;color:#1976d2;border:none;padding:6px 14px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;}
    .logout-btn:hover{background:#bbdefb;}
    .container{max-width:1100px;margin:30px auto;padding:0 20px;}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:10px;}
    .page-title{font-size:26px;color:#0d47a1;font-weight:700;}
    .section-title{font-size:22px;color:#1e88e5;margin:30px 0 20px;padding-bottom:10px;border-bottom:2px solid #e3f2fd;display:flex;align-items:center;gap:10px;}
    .new-request-btn{padding:10px 20px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:transform 0.2s,box-shadow 0.2s;}
    .new-request-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(33,150,243,0.3);}
    .requests-grid{display:grid;gap:22px;}
    .request-card{background:white;border-radius:18px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid #eef5ff;transition:all 0.3s ease;}
    .request-card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(30,136,229,0.12);}
    .status-header{height:6px;}
    .status-new{background:#2196f3;}
    .status-assigned{background:#00bcd4;}
    .status-in-progress{background:#ff9800;}
    .status-closed{background:#4caf50;}
    .status-rejected{background:#f44336;}
    .card-content{padding:24px;}
    .card-top{display:flex;justify-content:space-between;margin-bottom:14px;}
    .request-id{font-weight:700;color:#1e88e5;font-size:18px;}
    .request-date{color:#7f8c8d;font-size:14px;}
    .request-title{font-size:20px;margin-bottom:12px;color:#2c3e50;font-weight:600;}
    .request-desc{color:#555;margin-bottom:18px;line-height:1.6;font-size:15px;}
    .request-meta{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:18px;font-size:14px;color:#34495e;}
    .meta-item{display:flex;align-items:center;gap:6px;}
    .status-info{background:#f9fbfd;padding:12px;border-radius:12px;margin-bottom:18px;font-size:14px;color:#34495e;}
    .status-label{font-weight:600;color:#1e88e5;}
    .no-requests{text-align:center;padding:30px;color:#7f8c8d;font-style:italic;}
    .request-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
    .request-modal-content{background:white;width:90%;max-width:500px;border-radius:16px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
    .form-group{margin-bottom:20px;}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e;}
    .form-control{width:100%;padding:12px;border:2px solid #e3f2fd;border-radius:12px;font-family:'Tajawal',sans-serif;font-size:15px;direction:rtl;}
    .submit-btn{width:100%;padding:12px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;font-size:16px;cursor:pointer;}
    .submit-btn:hover{background:linear-gradient(to right,#1e88e5,#1565c0);}
    .export-section{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .export-btn{background:#43a047;color:white;padding:10px 18px;border:none;border-radius:10px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;}
    .export-btn:hover{background:#388e3c;}

    /* ğŸ¨ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ù…Ø­Ø¯Ø« */
    .chatbot-float-btn {
      position: fixed;
      bottom: 25px;
      left: 25px;
      background: linear-gradient(135deg,#42a5f5,#1e88e5);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(30,136,229,0.3);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .chatbot-float-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(30,136,229,0.5);
    }

    .chatbot-widget {
      position: fixed;
      bottom: 100px;
      left: 25px;
      width: 350px;
      max-height: 520px;
      background: #ffffff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 6px 25px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.3s ease;
    }
    .chatbot-widget:not(.hidden) {
      opacity: 1;
      transform: translateY(0);
    }
    .chatbot-widget.hidden { display: none; }

    .cb-header {
      background: linear-gradient(135deg,#2196f3,#1565c0);
      color:white;
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .cb-title{font-weight:700;font-size:15px;}
    .cb-close{background:transparent;border:none;color:white;font-size:18px;cursor:pointer;}

    .cb-body{
      flex:1;
      overflow-y:auto;
      padding:14px;
      background:#f8fbff;
    }
    .cb-msg{
      margin-bottom:12px;
      padding:10px 14px;
      border-radius:12px;
      max-width:80%;
      line-height:1.6;
      font-size:14px;
      word-wrap:break-word;
    }
    .cb-msg.user{
      background:#e3f2fd;
      color:#0d47a1;
      align-self:flex-end;
      margin-left:auto;
    }
    .cb-msg.bot{
      background:#e8f5e9;
      color:#2e7d32;
      align-self:flex-start;
    }
    .cb-typing{color:#aaa;font-size:14px;padding:10px;}

    .cb-input{
      display:flex;
      border-top:1px solid #e3f2fd;
      background:#ffffff;
    }
    .cb-input textarea{
      flex:1;
      border:none;
      padding:10px;
      resize:none;
      font-family:'Tajawal',sans-serif;
      font-size:14px;
      outline:none;
      background:#ffffff;
      color:#2c3e50;
    }
    .cb-send{
      background:#1e88e5;
      color:white;
      border:none;
      padding:0 16px;
      cursor:pointer;
      transition:0.2s;
    }
    .cb-send:hover{background:#1565c0;}
  </style>
</head>
<body>
<!-- Ù†ÙØ³ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ÙƒÙ…Ø§ Ù‡Ùˆ -->
<nav class="navbar">
  <div class="logo-box">
    <img src="{{ url_for('static', filename='7s.jpg') }}" alt="Ø´Ø¹Ø§Ø± SEVENS" />
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
  </div>
  <div class="user-info">
    <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
  </div>
</nav>

<div class="container">
  <div class="page-header">
    <h2 class="page-title" id="pageTitle">Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</h2>

    <div class="export-section">
      <input type="date" id="startDate" class="form-control" style="width:160px;">
      <input type="date" id="endDate" class="form-control" style="width:160px;">
      <button class="export-btn" onclick="exportRequests()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button class="new-request-btn" onclick="openNewRequestModal()"><i class="fas fa-plus"></i> Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <h3 class="section-title"><i class="fas fa-download"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…</h3>
  <div class="requests-grid" id="incoming-requests"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

  <h3 class="section-title"><i class="fas fa-upload"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø³Ù…</h3>
  <div class="requests-grid" id="outgoing-requests"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
<div class="request-modal" id="newRequestModal">
  <div class="request-modal-content">
    <h3 class="modal-title">Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <form id="newRequestForm">
      <div class="form-group">
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
        <input id="requestTitle" class="form-control" required />
      </div>
      <div class="form-group">
        <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
        <textarea id="requestDesc" class="form-control" rows="4" required></textarea>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
        <select id="targetDept" class="form-control" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
          <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
          <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</option>
          <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
          <option value="Ø§Ø¯Ø§Ø±Ø©  Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª">Ø§Ø¯Ø§Ø±Ø©  Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
          <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          <option value="Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©">Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©</option>
          <!-- Ø£Ø¶Ù Ø¨Ù‚ÙŠØ© Ø§Ù„ÙØ±ÙˆØ¹ ÙƒÙ…Ø§ ØªØ±ØºØ¨ -->
        </select>
      </div>
      <button type="submit" class="submit-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
  </div>
</div>

<div class="chatbot-float-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª -->
<div id="chatbotWidget" class="chatbot-widget hidden" aria-live="polite">
  <div class="cb-header">
    <div class="cb-title"><i class="fas fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ SEVENS</div>
    <button class="cb-close" onclick="toggleChat(false)" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fas fa-times"></i></button>
  </div>
  <div id="cbBody" class="cb-body"></div>
  <div class="cb-input">
    <textarea id="cbInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
    <button id="cbSend" class="cb-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>

function normalizeArabicJS(t){
  t = (t || '').toString().trim();
  t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§');
  t = t.replace(/\s+/g, '');
  t = t.replace(/Ø©/g, 'Ù‡');
  t = t.replace(/\u200f|\u200e/g, '');
  // âœ… Ø¥Ø¶Ø§ÙØ© ØªØ­ÙˆÙŠÙ„ ÙƒÙ„Ù…Ø© "Ø§Ø¯Ø§Ø±Ø©" Ø¥Ù„Ù‰ "Ø¥Ø¯Ø§Ø±Ø©" Ù…Ø«Ù„ Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯
  t = t.replace(/^Ø§Ø¯Ø§Ø±Ù‡?/g, 'Ø§Ø¯Ø§Ø±Ù‡');
  return t;
}



let currentUser = null;

/* ========== Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„ØµÙØ­Ø© ========== */
document.addEventListener('DOMContentLoaded', async () => {
  const userData = localStorage.getItem('currentUser');
  if (!userData) return location.href='Login.html';
  currentUser = JSON.parse(userData);
  if (currentUser.role !== 'Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…') return location.href='Login.html';

  document.getElementById('userWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (${currentUser.department})`;
  document.getElementById('pageTitle').textContent = `Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ù‚Ø³Ù… ${currentUser.department}`;

  const ta = document.getElementById('cbInput');
  ta.addEventListener('keydown', (e) => {
    if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
  });

  if (document.getElementById('cbBody').childElementCount===0){
    appendMsg('bot','Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ SEVENS. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ù‡Ø§Ù… ğŸ¤–');
  }

  await loadRequests();
});

/* ========== ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
async function loadRequests() {
  const res = await fetch('/api/get_requests', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({role: currentUser.role, department: currentUser.department})
  });
  const data = await res.json();

  // ğŸ”¹ ØªÙˆØ­ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…
  const deptStd = normalizeArabicJS(currentUser.department);

  // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© ÙÙ‚Ø· Ø¨Ø§Ù„Ù‚Ø³Ù… (Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©)
  const related = data.filter(r =>
    normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']) === deptStd ||
    normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']) === deptStd
  );

  // ğŸ”¸ ØªÙ‚Ø³ÙŠÙ…Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ø±Ø³Ù„Ø© ÙˆÙ…Ø³ØªÙ„Ù…Ø© ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶
  const incoming = related.filter(r => normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']) === deptStd);
  const outgoing = related.filter(r => normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']) === deptStd);

  renderRequests('incoming-requests', incoming);
  renderRequests('outgoing-requests', outgoing);
}


function renderRequests(containerId, list) {
  const c = document.getElementById(containerId);
  if (!Array.isArray(list) || !list.length) { c.innerHTML='<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>'; return; }
  c.innerHTML = list.map(req => {
    const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©']||'').trim();
    return `
    <div class="request-card" data-id="${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||''}">
      <div class="status-header ${statusToClass(status)}"></div>
      <div class="card-content">
        <div class="card-top">
          <div class="request-id">#${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||''}</div>
          <div class="request-date">${req['Ø§Ù„ØªØ§Ø±ÙŠØ®']||''}</div>
        </div>
        <h3 class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†']||''}</h3>
        <p class="request-desc">${req['Ø§Ù„ÙˆØµÙ']||''}</p>
        <div class="request-meta">
          <div class="meta-item"><i class="fas fa-building"></i> Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||''}</div>
          <div class="meta-item"><i class="fas fa-building"></i> Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||''}</div>
        </div>
        <div class="status-info">
          <div><span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${status}</div>
          <div><span class="status-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span> ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©']||'-'}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function statusToClass(s){
  if (s.includes('Ø¬Ø¯ÙŠØ¯')) return 'status-new';
  if (s.includes('Ù…ØºÙ„Ù‚')) return 'status-closed';
  if (s.includes('Ø¬Ø§Ø±ÙŠ'))  return 'status-in-progress';
  if (s.includes('Ù…Ø±ÙÙˆØ¶')) return 'status-rejected';
  return 'status-assigned';
}

/* ========== Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ========== */
document.getElementById('newRequestForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const t=document.getElementById('requestTitle').value.trim();
  const d=document.getElementById('requestDesc').value.trim();
  const dept=document.getElementById('targetDept').value;
  if(!t||!d||!dept) return alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');

  const res=await fetch('/api/create_request',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      title:t,description:d,targetDept:dept,
      senderDept:currentUser.department,senderName:currentUser.name
    })
  });
  const data=await res.json();
  if(data && data.success){
    alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    closeNewRequestModal();
    e.target.reset();
    loadRequests();
  }else{
    alert(data.message || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨');
  }
});

/* ========== ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
async function exportRequests() {
  const start = document.getElementById('startDate').value || null;
  const end   = document.getElementById('endDate').value   || null;

  const res = await fetch('/api/export_requests', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      department: currentUser.department,
      start_date: start,
      end_date: end
    })
  });

  const data = await res.json();
  if (data.success && data.file) {
    window.location.href = `/download/${data.file}`;
  } else {
    alert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
  }
}


/* ========== ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ========== */
function openNewRequestModal(){document.getElementById('newRequestModal').style.display='flex';}
function closeNewRequestModal(){document.getElementById('newRequestModal').style.display='none';}
window.onclick=e=>{const m=document.getElementById('newRequestModal');if(e.target===m)m.style.display='none';}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ========== */
function logout(){
  if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){
    localStorage.removeItem('currentUser');
    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    location.href='Login.html';
  }
}

/* ========== Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØµØºÙ‘Ø± ========= */
let cbOpen=false;
let chatHistory=[];

function toggleChat(force){
  const box=document.getElementById('chatbotWidget');
  cbOpen = (typeof force==='boolean') ? force : !cbOpen;
  box.classList.toggle('hidden', !cbOpen);
  if(cbOpen) setTimeout(()=>document.getElementById('cbInput').focus(),50);
}

function appendMsg(role,text){
  const body=document.getElementById('cbBody');
  const div=document.createElement('div');
  div.className='cb-msg '+(role==='user'?'user':'bot');
  div.textContent=text;
  body.appendChild(div);
  body.scrollTop=body.scrollHeight;
}
function appendTyping(){
  const body=document.getElementById('cbBody');
  const wrap=document.createElement('div');
  wrap.className='cb-typing'; wrap.id='cbTyping';
  wrap.innerHTML='<i class="fas fa-robot"></i> ÙŠÙÙƒØ± <span class="dots">...</span>';
  body.appendChild(wrap); body.scrollTop=body.scrollHeight;
}
function removeTyping(){ const el=document.getElementById('cbTyping'); if(el) el.remove(); }

async function sendChat(){
  const ta=document.getElementById('cbInput');
  const btn=document.getElementById('cbSend');
  const msg=ta.value.trim();
  if(!msg) return;

  appendMsg('user', msg);
  chatHistory.push({role:'user', content: msg});
  ta.value = '';
  btn.disabled = true;
  appendTyping();

  try {
    // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ù†Ø§:
    const res = await fetch('/chatbot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, history: chatHistory.slice(-8) })
    });

    const data = await res.json();
    removeTyping();

    if (data && data.reply) {
      const reply = (data.reply || '').trim() || '...';
      appendMsg('bot', reply);
      chatHistory.push({ role: 'assistant', content: reply });
    } else {
      appendMsg('bot', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹.');
    }
  } catch (e) {
    removeTyping();
    appendMsg('bot', 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯.');
  } finally {
    btn.disabled = false;
  }
}

</script>

</body>
</html>
