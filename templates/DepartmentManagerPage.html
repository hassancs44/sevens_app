<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… | SEVENS</title>

  <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* ğŸ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
    body{background:#f8fbff;color:#2c3e50;min-height:100vh;}
    .navbar{background:white;padding:18px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 12px rgba(0,0,0,0.06);position:sticky;top:0;z-index:100;}
    .logo-box{display:flex;align-items:center;gap:14px;}
    .logo-box img{width:44px;height:44px;object-fit:contain;border-radius:10px;}
    .logo-box h1{color:#1e88e5;font-size:22px;font-weight:700;}
    .user-info{display:flex;align-items:center;gap:12px;color:#34495e;font-weight:600;}
    .logout-btn{background:#e3f2fd;color:#1976d2;border:none;padding:6px 14px;border-radius:8px;font-weight:600;cursor:pointer;}
    .logout-btn:hover{background:#bbdefb;}
    .container{max-width:1100px;margin:30px auto;padding:0 20px;}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:10px;}
    .page-title{font-size:26px;color:#0d47a1;font-weight:700;}
    .section-title{font-size:22px;color:#1e88e5;margin:30px 0 20px;padding-bottom:10px;border-bottom:2px solid #e3f2fd;display:flex;align-items:center;gap:10px;}
    .new-request-btn{padding:10px 20px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;}
    .new-request-btn:hover{box-shadow:0 4px 12px rgba(33,150,243,0.3);}
    .requests-grid{display:grid;gap:22px;}
    .request-card{background:white;border-radius:18px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.06);border:1px solid #eef5ff;transition:all 0.3s ease;}
    .request-card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(30,136,229,0.12);}
    .status-header{height:6px;}
    .status-new{background:#2196f3;}
    .status-in-progress{background:#ff9800;}
    .status-closed{background:#4caf50;}
    .status-rejected{background:#f44336;}
    .card-content{padding:24px;}
    .request-title{font-size:20px;margin-bottom:12px;color:#2c3e50;font-weight:600;}
    .request-desc{color:#555;margin-bottom:18px;line-height:1.6;font-size:15px;}
    .status-info{background:#f9fbfd;padding:12px;border-radius:12px;margin-bottom:18px;font-size:14px;color:#34495e;}
    .no-requests{text-align:center;padding:30px;color:#7f8c8d;font-style:italic;}
    .export-section{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .export-btn{background:#43a047;color:white;padding:10px 18px;border:none;border-radius:10px;font-weight:600;cursor:pointer;}
    .export-btn:hover{background:#388e3c;}
    #statusFilter{border:2px solid #e3f2fd;border-radius:10px;padding:10px;background:white;color:#0d47a1;font-weight:600;}
    #statusFilter:focus{outline:none;border-color:#1e88e5;box-shadow:0 0 8px rgba(30,136,229,0.3);}

    /* âœ³ï¸ ØªÙˆÙ‡Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ° */
    .card-glow{
      border:2px solid #81c784 !important;
      box-shadow:0 0 18px rgba(129,199,132,0.6) !important;
      transition:all .3s ease-in-out;
    }

    /* ğŸ¤– Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª */
    .chatbot-float-btn{position:fixed;bottom:25px;left:25px;background:linear-gradient(135deg,#42a5f5,#1e88e5);color:white;width:60px;height:60px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:26px;cursor:pointer;box-shadow:0 6px 20px rgba(30,136,229,0.3);z-index:1000;}
    .chatbot-widget{position:fixed;bottom:100px;left:25px;width:350px;max-height:520px;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 6px 25px rgba(0,0,0,0.15);display:none;flex-direction:column;z-index:1000;}
    .chatbot-widget.show{display:flex;}
    .cb-header{background:linear-gradient(135deg,#2196f3,#1565c0);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;}
    .cb-body{flex:1;overflow-y:auto;padding:14px;background:#f8fbff;}
    .cb-msg{margin-bottom:12px;padding:10px 14px;border-radius:12px;max-width:80%;line-height:1.6;font-size:14px;}
    .cb-msg.user{background:#e3f2fd;color:#0d47a1;margin-left:auto;}
    .cb-msg.bot{background:#e8f5e9;color:#2e7d32;}
    .cb-input{display:flex;border-top:1px solid #e3f2fd;}
    .cb-input textarea{flex:1;border:none;padding:10px;font-family:'Tajawal';font-size:14px;resize:none;}
    .cb-send{background:#1e88e5;color:white;border:none;padding:0 16px;cursor:pointer;}
    /* âœ… Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù†Ø¨Ø«Ù‚ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ) */
.request-modal {
  display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ */
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.request-modal-content {
  background: #fff;
  width: 90%;
  max-width: 500px;
  border-radius: 18px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  position: relative;
  text-align: right;
}

.form-group {
  margin-bottom: 20px;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #e3f2fd;
  border-radius: 12px;
  font-size: 15px;
  direction: rtl;
}

.submit-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(to right,#2196f3,#1976d2);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
}

.submit-btn:hover {
  background: linear-gradient(to right,#1e88e5,#1565c0);
}

  </style>
</head>

<body>
  <!-- ğŸ”¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <nav class="navbar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}" alt="Ø´Ø¹Ø§Ø± SEVENS">
      <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
  </nav>

  <!-- ğŸ”¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <div class="container">
    <div class="page-header">
      <h2 class="page-title" id="pageTitle">Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</h2>

      <div class="export-section">
        <select id="statusFilter" onchange="filterRequestsByStatus()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
          <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
          <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
        </select>

        <button class="export-btn" style="background:#1e88e5" onclick="loadRequests()">
          <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
        </button>

        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button class="export-btn" onclick="exportRequests()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="new-request-btn" onclick="openNewRequestModal()"><i class="fas fa-plus"></i> Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </div>

    <h3 class="section-title"><i class="fas fa-download"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
    <div class="requests-grid" id="incoming-requests"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

    <h3 class="section-title"><i class="fas fa-upload"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>
    <div class="requests-grid" id="outgoing-requests"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>

  <!-- ğŸ”¹ Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ø·Ù„Ø¨ -->
  <div class="request-modal" id="newRequestModal">
    <div class="request-modal-content">
      <h3>Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="newRequestForm">
        <div class="form-group">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="requestTitle" class="form-control" required />
        </div>
        <div class="form-group">
          <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
          <textarea id="requestDesc" class="form-control" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
        <select id="targetDept" class="form-control" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>

          <!-- ğŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
          <optgroup label="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</option>
            <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØªØ£Ø¬ÙŠØ±</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          </optgroup>

          <!-- ğŸ’¼ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù‡Ø§ØªÙÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
            <option value="Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ø©">Ù‚Ø³Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµØ§Ù„Ø© - Ø¬Ø¯Ø©</option>
          </optgroup>

          <!-- ğŸ”§ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª">
            <option value="Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©">Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª - ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</option>
          </optgroup>

          <!-- ğŸ§¾ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
            <option value="Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª">Ù‚Ø³Ù… Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          </optgroup>

          <!-- ğŸ§¹ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
          <optgroup label="Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 1</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ 2</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ø©">Ù‚Ø³Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø¯Ø©</option>
            <option value="Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©">Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©</option>
          </optgroup>

          <!-- ğŸ¬ Ø§Ù„ÙØ±ÙˆØ¹ -->
          <optgroup label="Ø§Ù„ÙØ±ÙˆØ¹">
            <option value="Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©">Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹ Ø¬Ø¯Ø©</option>
          </optgroup>
          </select>
        </div>

        <div class="form-group">
  <label>Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
  <input type="file" id="requestFile" class="form-control" accept=".pdf,.jpg,.png,.docx,.xlsx"/>
</div>
        <button type="submit" class="submit-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </form>
    </div>
  </div>

  <!-- ğŸ¤– Ø²Ø± Ø§Ù„Ø´Ø§Øª -->
  <div class="chatbot-float-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª -->
  <div id="chatbotWidget" class="chatbot-widget">
    <div class="cb-header">
      <div>Ù…Ø³Ø§Ø¹Ø¯ SEVENS</div>
      <button class="cb-close" onclick="toggleChat(true)">âœ–</button>
    </div>
    <div id="cbBody" class="cb-body"></div>
    <div class="cb-input">
      <textarea id="cbInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."></textarea>
      <button id="cbSend" class="cb-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- ğŸ”¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
  <script>
/* ========== Ø¯Ø§Ù„Ø© ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ========== */
function normalizeArabicJS(t){
  t = (t || '').toString().trim();
  t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§');
  t = t.replace(/\s+/g, '');
  t = t.replace(/Ø©/g, 'Ù‡');
  t = t.replace(/\u200f|\u200e/g, '');
  t = t.replace(/^Ø§Ø¯Ø§Ø±Ù‡?/g, 'Ø§Ø¯Ø§Ø±Ù‡');
  return t;
}

/* ========== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ========== */
let currentUser = null;
let chatHistory = [];
let activeTimers = {};

/* ========== Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ========== */
document.addEventListener('DOMContentLoaded', async () => {
  const userData = localStorage.getItem('currentUser');
  if (!userData) return location.href = 'Login.html';
  currentUser = JSON.parse(userData);
  if (currentUser.role !== 'Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…') return location.href = 'Login.html';

  document.getElementById('userWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (${currentUser.department})`;
  document.getElementById('pageTitle').textContent = `Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ù‚Ø³Ù… ${currentUser.department}`;

  const ta = document.getElementById('cbInput');
  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
  });

  appendMsg('bot', 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ SEVENS. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ù‡Ø§Ù… ğŸ¤–');
  await loadRequests();

  // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
  setInterval(loadRequests, 60000);
});

/* ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
async function loadRequests() {
  const res = await fetch('/api/get_requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ role: currentUser.role, department: currentUser.department })
  });
  const data = await res.json();
  const deptStd = normalizeArabicJS(currentUser.department);

  const related = data.filter(r =>
    normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']) === deptStd ||
    normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']) === deptStd
  );

  renderRequests('incoming-requests', related.filter(r => normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']) === deptStd));
  renderRequests('outgoing-requests', related.filter(r => normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']) === deptStd));

  filterRequestsByStatus(); // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„ØªØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
}

/* ========== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
function renderRequests(containerId, list) {
  const c = document.getElementById(containerId);
  if (!Array.isArray(list) || !list.length) {
    c.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>';
    return;
  }

  c.innerHTML = list.map(req => {
    const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©'] || '').trim();
    return `
      <div class="request-card" data-id="${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || ''}">
        <div class="status-header ${statusToClass(status)}"></div>
        <div class="card-content">
          <div class="card-top">
            <div class="request-id">#${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || ''}</div>
            <div class="request-date">${req['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || ''}</div>
          </div>
          <h3 class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || ''}</h3>
          <p class="request-desc">${req['Ø§Ù„ÙˆØµÙ'] || ''}</p>
          <div class="request-meta">
            <div class="meta-item"><i class="fas fa-user"></i> Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'})</div>
            <div class="meta-item"><i class="fas fa-user-check"></i> Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'})</div>
          </div>
          <div class="status-info">
            <div><span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${status}</div>
            <div><span class="status-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span> ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©'] || '-'}</div>
          </div>
        </div>
      </div>`;
  }).join('');
}

/* ========== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª ========== */
function statusToClass(s) {
  if (s.includes('Ø¬Ø¯ÙŠØ¯')) return 'status-new';
  if (s.includes('Ù…ØºÙ„Ù‚')) return 'status-closed';
  if (s.includes('Ø¬Ø§Ø±ÙŠ')) return 'status-in-progress';
  if (s.includes('Ù…Ø±ÙÙˆØ¶')) return 'status-rejected';
  return 'status-assigned';
}

/* ========== ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ========== */
function filterRequestsByStatus() {
  const status = document.getElementById('statusFilter').value.trim();
  const allCards = document.querySelectorAll('.request-card');
  allCards.forEach(card => {
    const text = card.innerText || '';
    card.style.display = (!status || text.includes(status)) ? 'block' : 'none';
  });
}


/* ========== ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
async function exportRequests() {
  const start = document.getElementById('startDate').value || null;
  const end = document.getElementById('endDate').value || null;

  const res = await fetch('/api/export_requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ department: currentUser.department, start_date: start, end_date: end })
  });
  const data = await res.json();
  if (data.success && data.file) window.location.href = `/download/${data.file}`;
  else alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
}

/* ========== ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ ========== */
function openNewRequestModal() {
  document.getElementById('newRequestModal').style.display = 'flex';
}
function closeNewRequestModal() {
  document.getElementById('newRequestModal').style.display = 'none';
}
window.onclick = e => {
  const m = document.getElementById('newRequestModal');
  if (e.target === m) m.style.display = 'none';
};

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ========== */
function logout() {
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
    localStorage.removeItem('currentUser');
    location.href = 'Login.html';
  }
}


/* ========== Ø§Ù„Ø´Ø§Øª ========== */
function toggleChat(forceClose=false){
  const box = document.getElementById('chatbotWidget');
  if (forceClose) {
    box.classList.remove('show'); // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù‚ÙˆØ©
  } else {
    box.classList.toggle('show'); // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© (ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚)
  }
}

function appendMsg(role, text) {
  const body = document.getElementById('cbBody');
  const msg = document.createElement('div');
  msg.className = 'cb-msg ' + (role === 'user' ? 'user' : 'bot');
  msg.textContent = text;
  body.appendChild(msg);
  body.scrollTop = body.scrollHeight;
}

async function sendChat() {
  const input = document.getElementById('cbInput');
  const text = input.value.trim();
  if (!text) return;
  appendMsg('user', text);
  input.value = '';

  const typing = document.createElement('div');
  typing.className = 'cb-typing';
  typing.innerHTML = '<i class="fas fa-robot"></i><span class="dots">...</span>';
  document.getElementById('cbBody').appendChild(typing);

  try {
    const res = await fetch('/chatbot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    const data = await res.json();
    typing.remove();
    appendMsg('bot', data.reply || 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£.');
  } catch (e) {
    typing.remove();
    appendMsg('bot', 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
  }
}

    /* ========= Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯  ========= */
document.getElementById('newRequestForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // ğŸ”¹ Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  const title = document.getElementById('requestTitle').value.trim();
  const desc  = document.getElementById('requestDesc').value.trim();
  const targetDept = document.getElementById('targetDept').value.trim();
  const fileInput = document.getElementById('requestFile');

  // ğŸ”¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  if (!title || !desc || !targetDept) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
    return;
  }

  // ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
  const formData = new FormData();
  formData.append('title', title);
  formData.append('description', desc);
  formData.append('targetDept', targetDept);
  formData.append('senderDept', currentUser.department);
  formData.append('senderName', currentUser.name);

  // ğŸ”¸ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù Ø¥Ù† ÙˆÙØ¬Ø¯
  if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
  }

  try {
    // ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const res = await fetch('/api/create_request', {
      method: 'POST',
      body: formData // Ù„Ø§ ØªØ¶Ø¹ Content-Type Ù‡Ù†Ø§ØŒ ÙŠØ­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    });

    // ğŸ”¸ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    const data = await res.json();

    // ğŸ”¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    if (data.success) {
      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
      closeNewRequestModal();                  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
      document.getElementById('newRequestForm').reset();  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      renderRequests('requestsContainer', await fetchRequests()); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    } else {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (data.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
    }

  } catch (e) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', e);
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„.");
  }
});

</script>

</body>
</html>
