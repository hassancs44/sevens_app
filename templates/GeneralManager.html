<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة المدير العام | SEVENS</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
    body{background:#f8fbff;color:#2c3e50;min-height:100vh;display:flex;}
    .status-header{height:6px;}
    .status-new{background:#2196f3;}
    .status-assigned{background:#00bcd4;}
    .status-in-progress{background:#ff9800;}
    .status-on-hold{background:#ff5722;}
    .status-closed{background:#4caf50;}
    .status-rejected{background:#f44336;}
    .card-content{padding:24px;}
    .card-top{display:flex;justify-content:space-between;margin-bottom:14px;}
    .request-id{font-weight:700;color:#1e88e5;font-size:18px;}
    .request-date{color:#7f8c8d;font-size:14px;}
    .request-title{font-size:20px;margin-bottom:12px;color:#2c3e50;font-weight:600;}
    .request-desc{color:#555;margin-bottom:18px;line-height:1.6;font-size:15px;}
    .request-meta{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:18px;font-size:14px;color:#34495e;}
    .meta-item{display:flex;align-items:center;gap:6px;}
    .logout-btn{background:#e3f2fd;color:#1976d2;border:none;padding:6px 14px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;}
    .logout-btn:hover{background:#bbdefb;}
    .sidebar{width:250px;background:white;height:100vh;position:fixed;top:0;right:0;box-shadow:-2px 0 10px rgba(0,0,0,0.08);z-index:999;padding-top:70px;overflow-y:auto;}
    .sidebar-header{padding:16px 20px;font-weight:700;color:#0d47a1;border-bottom:1px solid #eee;font-size:18px;}
    .dept-list{list-style:none;padding:0;}
    .dept-item{padding:14px 20px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:12px;border-right:3px solid transparent;}
    .dept-item:hover{background:#f5f9ff;}
    .dept-item.active{background:#e3f2fd;border-right:3px solid #1e88e5;color:#1e88e5;font-weight:600;}
    .dept-item i{width:24px;text-align:center;}
    .main-content{flex:1;margin-right:250px;padding:30px 20px 20px;margin-top:70px;}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .page-title{font-size:26px;color:#0d47a1;font-weight:700;}
    .new-request-btn{padding:10px 20px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:transform 0.2s,box-shadow 0.2s;}
    .new-request-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(33,150,243,0.3);}
    .requests-grid{display:grid;gap:20px;}
    .request-card{background:white;border-radius:16px;padding:22px;box-shadow:0 4px 12px rgba(0,0,0,0.05);border:1px solid #f0f7ff;transition:all 0.2s ease;}
    .request-card:hover{box-shadow:0 6px 16px rgba(30,136,229,0.1);}
    .status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600;color:white;}
    .status-info{font-size:13px;color:#555;}
    .status-label{font-weight:600;color:#1e88e5;}
    .no-requests{text-align:center;padding:40px;color:#7f8c8d;font-style:italic;font-size:16px;}
    .request-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;}
    .request-modal-content{background:white;width:90%;max-width:500px;border-radius:16px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
    .form-group{margin-bottom:20px;}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e;}
    .form-control{width:100%;padding:12px;border:2px solid #e3f2fd;border-radius:12px;font-family:'Tajawal',sans-serif;font-size:15px;direction:rtl;}
    .submit-btn{width:100%;padding:12px;background:linear-gradient(to right,#2196f3,#1976d2);color:white;border:none;border-radius:12px;font-weight:600;font-size:16px;cursor:pointer;}
    .submit-btn:hover{background:linear-gradient(to right,#1e88e5,#1565c0);}
    .chatbot-float-btn{position:fixed;bottom:30px;left:30px;width:60px;height:60px;background:linear-gradient(to right,#2196f3,#1976d2);border-radius:50%;display:flex;justify-content:center;align-items:center;color:white;font-size:24px;cursor:pointer;box-shadow:0 4px 12px rgba(33,150,243,0.4);z-index:999;transition:transform 0.2s;}
    .chatbot-float-btn:hover{transform:scale(1.1);}
    /* زر الشات + نافذة مصغّرة (يمين/أسفل) */
    .chatbot-float-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:linear-gradient(135deg,#1976d2,#42a5f5);border-radius:50%;display:flex;justify-content:center;align-items:center;color:white;font-size:22px;cursor:pointer;box-shadow:0 8px 24px rgba(25,118,210,.35);z-index:1500;}
    .chatbot-widget{position:fixed;bottom:88px;right:24px;width:360px;max-height:540px;background:#fff;border:1px solid #e6eefc;border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.12);display:flex;flex-direction:column;overflow:hidden;z-index:1500;}
    .hidden{display:none!important;}
    .cb-header{background:linear-gradient(90deg,#1976d2,#1e88e5);color:#fff;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;}
    .cb-title{display:flex;align-items:center;gap:8px;font-weight:700}
    .cb-close{background:transparent;border:none;color:#fff;font-size:16px;cursor:pointer}
    .cb-body{padding:10px;height:100%;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#f8fbff}
    .cb-msg{max-width:85%;padding:8px 10px;border-radius:12px;line-height:1.5;font-size:14px;white-space:pre-wrap}
    .cb-msg.user{align-self:flex-end;background:#e3f2fd;border-top-left-radius:4px}
    .cb-msg.bot{align-self:flex-start;background:#ffffff;border:1px solid #ecf2ff;border-top-right-radius:4px}
    .cb-input{padding:8px;border-top:1px solid #e6eefc;background:#fff;display:flex;gap:8px;align-items:flex-end}
    .cb-input textarea{flex:1;resize:none;min-height:40px;max-height:120px;padding:8px;border:2px solid #e6eefc;border-radius:10px;font-size:14px;direction:rtl}
    .cb-send{padding:9px 12px;background:#1976d2;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .cb-send:disabled{opacity:.6;cursor:not-allowed}
    .cb-typing{align-self:flex-start;color:#888;font-size:12px;display:flex;align-items:center;gap:6px}
    .cb-typing .dots{letter-spacing:2px;animation:blink 1.4s infinite}
    @keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}

    /* ✅ إصلاح مشكلة الأزرار غير القابلة للنقر */
.chatbot-widget.hidden,
.file-viewer-modal:not([style*="display: flex"]) {
  pointer-events: none !important;
  opacity: 0;
}

.chatbot-widget.hidden {
  display: none !important;
}

/* ضمان أن النوافذ العائمة لا تغطي إلا عند الفتح */
.chatbot-widget,
.file-viewer-modal {
  pointer-events: auto;
}

    /* 🎨 تصميم فلتر القسم مع البحث */
.searchable-select {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 220px;
  background: white;
  border: 2px solid #e3f2fd;
  border-radius: 10px;
  overflow: hidden;
}

.searchable-select input {
  border: none;
  border-bottom: 1px solid #e3f2fd;
  padding: 8px 10px;
  outline: none;
  font-family: 'Tajawal';
  font-size: 14px;
}

.searchable-select select {
  border: none;
  outline: none;
  padding: 5px;
  height: 150px;
  overflow-y: auto;
  font-family: 'Tajawal';
  background: white;
}

.searchable-select select option {
  padding: 6px 10px;
}

.searchable-select select option:hover {
  background: #e3f2fd;
}

  </style>
</head>
<body>

<div class="sidebar">
  <select id="deptSelect" class="form-control" onchange="loadRequestsForUser(this.value)">
    <option value="all">جميع الطلبات</option>
    <optgroup label="الإدارات الرئيسية">
      <option>الإدارة العامة</option>
      <option>الإدارة الإدارية</option>
      <option>الإدارة المالية</option>
      <option>إدارة المراجعة</option>
      <option>إدارة تحليل البيانات</option>
      <option>إدارة الموارد البشرية</option>
      <option>إدارة تقنية المعلومات</option>
      <option>إدارة التسويق</option>
      <option>إدارة التشغيل</option>
      <option>إدارة مكتب التأجير</option>
      <option>إدارة الصيانة وقطع الغيار</option>
      <option>إدارة المبيعات</option>
      <option>إدارة المخزون - مستودع السيارات</option>
    </optgroup>
    <optgroup label="فروع المدينة">
      <option>إدارة المبيعات الهاتفية - المدينة</option>
      <option>قسم المبيعات الهاتفية</option>
      <option>مبيعات الصالة - المدينة</option>
      <option>قسم مبيعات الصالة المدينة المنورة</option>
      <option>قسم النظافة والاستقبال المدينة</option>
      <option>قسم الخدمات</option>
      <option>قسم الاستقبال والنظافة</option>
      <option>قسم المشتريات</option>
      <option>قسم الخدمات - فني صيانة</option>
    </optgroup>
    <optgroup label="فروع الرياض">
      <option>إدارة فرع الرياض 1</option>
      <option>قسم مبيعات الصالة الرياض 1</option>
      <option>قسم النظافة والاستقبال الرياض 1</option>
      <option>إدارة فرع الرياض 2</option>
      <option>قسم مبيعات الصالة الرياض 2</option>
      <option>قسم النظافة والاستقبال الرياض 2</option>
      <option>إدارة المبيعات الهاتفية - الرياض</option>
      <option>قسم المبيعات الهاتفية الرياض</option>
      <option>قسم النظافة والاستقبال الرياض</option>
    </optgroup>
    <optgroup label="فرع جدة">
      <option>إدارة فرع جدة</option>
      <option>قسم مبيعات الصالة - جدة</option>
      <option>قسم النظافة والاستقبال جدة</option>
    </optgroup>
  </select>
</div>

<div class="main-content">
  <nav class="navbar">
    <div class="logo-box">
      <h1>نظام إدارة الطلبات</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">جارٍ التحميل...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
    </div>
  </nav>

  <div class="page-header">
    <h2 class="page-title" id="sectionTitle">جميع الطلبات</h2>
    <button class="new-request-btn" onclick="openNewRequestModal()"><i class="fas fa-plus"></i> رفع طلب جديد</button>
  </div>

  <div class="requests-grid" id="requestsContainer"><div class="no-requests">جارٍ التحميل...</div></div>
</div>

<div class="request-modal" id="newRequestModal">
  <div class="request-modal-content">
    <h3 class="modal-title">رفع طلب جديد</h3>
    <form id="newRequestForm">
      <div class="form-group">
        <label>عنوان الطلب</label>
        <input id="requestTitle" class="form-control" required />
      </div>
      <div class="form-group">
        <label>وصف الطلب</label>
        <textarea id="requestDesc" class="form-control" required></textarea>
      </div>
      <div class="form-group">
        <label>القسم المستلم</label>
        <select id="targetDept" class="form-control" required>
  <option value="">اختر القسم</option>

  <!-- 🏢 الإدارات الرئيسية -->
  <optgroup label="الإدارات الرئيسية">
    <option value="الإدارة العامة">الإدارة العامة</option>
    <option value="الإدارة الإدارية">الإدارة الإدارية</option>
    <option value="الإدارة المالية">الإدارة المالية</option>
    <option value="إدارة المراجعة">إدارة المراجعة</option>
    <option value="إدارة تحليل البيانات">إدارة تحليل البيانات</option>
    <option value="إدارة الموارد البشرية">إدارة الموارد البشرية</option>
    <option value="إدارة التقنية والشبكات">إدارة التقنية والشبكات</option>
    <option value="إدارة التسويق">إدارة التسويق</option>
    <option value="إدارة التشغيل">إدارة التشغيل</option>
    <option value="إدارة مكتب التأجير">إدارة مكتب التأجير</option>
    <option value="إدارة الصيانة وقطع الغيار">إدارة الصيانة وقطع الغيار</option>
    <option value="إدارة المبيعات">إدارة المبيعات</option>
    <option value="إدارة المخزون - مستودع السيارات">إدارة المخزون - مستودع السيارات</option>
    <option value="قسم المشتريات">قسم المشتريات</option>
  </optgroup>

  <!-- 💼 أقسام المبيعات -->
  <optgroup label="أقسام المبيعات">
    <option value="قسم المبيعات الهاتفية">قسم المبيعات الهاتفية</option>
    <option value="قسم المبيعات الهاتفية الرياض">قسم المبيعات الهاتفية الرياض</option>
    <option value="قسم مبيعات الصالة المدينة المنورة">قسم مبيعات الصالة المدينة المنورة</option>
    <option value="قسم مبيعات الصالة الرياض 1">قسم مبيعات الصالة الرياض 1</option>
    <option value="قسم مبيعات الصالة الرياض 2">قسم مبيعات الصالة الرياض 2</option>
    <option value="قسم مبيعات الصالة - جدة">قسم مبيعات الصالة - جدة</option>
  </optgroup>

  <!-- 🔧 أقسام الصيانة والخدمات -->
  <optgroup label="أقسام الصيانة والخدمات">
    <option value="قسم استقبال عملاء الصيانة">قسم استقبال عملاء الصيانة</option>
    <option value="قسم خدمة عملاء الصيانة">قسم خدمة عملاء الصيانة</option>
    <option value="قسم الخدمات - فني صيانة">قسم الخدمات - فني صيانة</option>
  </optgroup>

  <!-- 🧾 أقسام المخزون والمشتريات -->
  <optgroup label="أقسام المخزون والمشتريات">
    <option value="قسم مخزون السيارات">قسم مخزون السيارات</option>
    <option value="قسم المشتريات">قسم المشتريات</option>
  </optgroup>

  <!-- 🧹 أقسام النظافة والاستقبال -->
  <optgroup label="أقسام النظافة والاستقبال">
    <option value="قسم النظافة والاستقبال المدينة">قسم النظافة والاستقبال المدينة</option>
    <option value="قسم النظافة والاستقبال الرياض 1">قسم النظافة والاستقبال الرياض 1</option>
    <option value="قسم النظافة والاستقبال الرياض 2">قسم النظافة والاستقبال الرياض 2</option>
    <option value="قسم النظافة والاستقبال جدة">قسم النظافة والاستقبال جدة</option>
    <option value="قسم الاستقبال والنظافة">قسم الاستقبال والنظافة</option>
  </optgroup>

  <!-- 🏬 الفروع -->
  <optgroup label="الفروع">
    <option value="إدارة فرع جدة">إدارة فرع جدة</option>
  </optgroup>
</select>

<div class="form-group">
  <label>إرفاق ملف (اختياري)</label>
  <input type="file" id="requestFile" class="form-control" accept=".pdf,.jpg,.png,.docx,.xlsx"/>
</div>

      </div>
      <button type="submit" class="submit-btn">إرسال الطلب</button>
    </form>
  </div>
</div>

<!-- زر الشات العائم -->
<div class="chatbot-float-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>

<!-- نافذة الشات المصغّرة -->
<div id="chatbotWidget" class="chatbot-widget hidden" aria-live="polite">
  <div class="cb-header">
    <div class="cb-title"><i class="fas fa-robot"></i> مساعد SEVENS</div>
    <button class="cb-close" onclick="toggleChat(false)" title="إغلاق"><i class="fas fa-times"></i></button>
  </div>
  <div id="cbBody" class="cb-body"></div>
  <div class="cb-input">
    <textarea id="cbInput" placeholder="اكتب رسالتك... (Enter للإرسال، Shift+Enter لسطر جديد)"></textarea>
    <button id="cbSend" class="cb-send" onclick="sendChat()">إرسال</button>
  </div>
</div>

<!-- 🗂️ نافذة عرض المرفقات -->
<div id="fileViewerModal" class="file-viewer-modal" onclick="closeFileViewer(event)">
  <div class="file-viewer-content">
    <span class="close-btn" onclick="closeFileViewer(event)">&times;</span>
    <h3 id="fileViewerTitle" style="margin-bottom:10px;color:#1976d2;"></h3>
    <div id="fileViewerBody" class="file-viewer-body"></div>
  </div>
</div>

<script>
/* ========== تعريف المستخدم الحالي ========== */
let currentUser = null;
let chatHistory = [];
let activeTimers = {};
let allEmployees = [];

/* ========== دالة إضافة رسالة في واجهة الشات ========== */
/* 🔹 تعريف الدالة قبل الاستدعاء */
function appendMsg(sender, text) {
  const cbBody = document.getElementById("cbBody");
  if (!cbBody) return;
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("cb-msg", sender === "user" ? "user" : "bot");
  msgDiv.textContent = text;
  cbBody.appendChild(msgDiv);
  cbBody.scrollTop = cbBody.scrollHeight;
}

/* 🔹 عند تحميل الصفحة */
window.onload = async () => {
  console.log("🚀 بدء تشغيل الصفحة...");
  let userData = null;
  for (let i = 0; i < 10; i++) {
    userData = localStorage.getItem("currentUser");
    if (userData) break;
    await new Promise(r => setTimeout(r, 300));
  }

  if (!userData) return location.href = "Login.html";
  currentUser = JSON.parse(userData);

  document.getElementById("userWelcome").textContent =
    `مرحباً، ${currentUser.name} (${currentUser.department})`;
  document.getElementById("pageTitle").textContent =
    `لوحة قسم ${currentUser.department}`;

  // ✅ السطر الصحيح هنا
  appendMsg("bot", "مرحباً! أنا مساعد SEVENS، اسألني أي شيء بخصوص الطلبات 🤖");

  // 🧩 تحميل قائمة الموظفين من السيرفر
  try {
    const res = await fetch('/api/get_employees', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ manager_name: currentUser.name, department: currentUser.department })
});

    const data = await res.json();
    if (data.success) {
      allEmployees = data.employees;
      console.log("✅ تم تحميل الموظفين:", allEmployees.length);
    } else {
      console.warn("⚠️ فشل تحميل الموظفين:", data.message);
    }
  } catch (err) {
    console.error("❌ خطأ أثناء تحميل الموظفين:", err);
  }


  setTimeout(() => loadRequests(), 1000);
};
console.log("📡 تم استدعاء loadRequests() فعلاً");

function loadRequests() {
  loadRequestsForUser(currentUser.department);
}


/* ========== 🧩 دالة توحيد جميع الأقسام الموجودة بالإكسل ========== */
/* ✅ دالة موحدة شاملة لتطابق جميع الأقسام مهما اختلف الاسم */
function normalizeDepartmentJS(name) {
  if (!name) return '';
  let n = name.toString().trim().toLowerCase();
  n = n.replace(/[إأآا]/g, 'ا').replace(/\s+/g, '').replace(/ة/g, 'ه');

  // 🏢 الإدارات الرئيسية
  if (n.includes('الادارهالعامه')) return 'الادارهالعامه';
  if (n.includes('الادارهالاداريه')) return 'الادارهالاداريه';
  if (n.includes('الماليه')) return 'الادارهالماليه';
  if (n.includes('المراجعه')) return 'ادارهالمراجعه';
  if (n.includes('تحليل') || n.includes('البيانات')) return 'ادارهتحليلالبيانات';
  if (n.includes('موارد') || n.includes('بشر')) return 'ادارهالمواردالبشريه';
  if (n.includes('تقنيه') || n.includes('شبك')) return 'ادارهالتقنيهوالشبكات';
  if (n.includes('تسويق')) return 'ادارهالتسويق';
  if (n.includes('تشغيل')) return 'ادارهالتشغيل';
  if (n.includes('تاجير') || n.includes('مكتبتاجير')) return 'ادارهالمكتبتاجير';
  if (n.includes('صيان') || n.includes('قطع')) return 'ادارهالصيانهوقطعالغيار';
  if (n.includes('مبيعات') && !n.includes('صاله') && !n.includes('هاتفي')) return 'ادارهالمبيعات';
  if (n.includes('مخزون') || n.includes('مستودع')) return 'ادارهالمخزونمستودعالسيارات';
  if (n.includes('مشتريات')) return 'قسمالمشتريات';

  // 💼 أقسام المبيعات
  if (n.includes('هاتفي') || n.includes('الهاتفيه')) {
    if (n.includes('رياض')) return 'قسمالمبيعاتالهاتفيهالرياض';
    return 'قسمالمبيعاتالهاتفيه';
  }

  if (n.includes('صاله')) {
    if (n.includes('مدينه')) return 'قسممبيعاتالصالهالمدينهمنوره';
    if (n.includes('جده')) return 'قسممبيعاتالصالهجده';
    if (n.includes('رياض') && n.includes('1')) return 'قسممبيعاتالصالهالرياض1';
    if (n.includes('رياض') && n.includes('2')) return 'قسممبيعاتالصالهالرياض2';
    return 'قسممبيعاتالصاله';
  }

  // 🔧 الصيانة والخدمات
  if (n.includes('استقبال') && n.includes('صيان')) return 'قسماستقبالعملاءالصيانه';
  if (n.includes('خدمه') && n.includes('عملاء')) return 'قسمخدمعملاءالصيانه';
  if (n.includes('فني') && n.includes('صيان')) return 'قسمالخدماتفنيصيانة';

  // 🧾 المخزون والمشتريات
  if (n.includes('مخزون') && n.includes('سيارات')) return 'قسممخزونالسيارات';

  // 🧹 النظافة والاستقبال
  if (n.includes('نظاف') || n.includes('استقبال')) {
    if (n.includes('مدينه')) return 'قسمالنظافهوالاستقبالالمدينه';
    if (n.includes('جده')) return 'قسمالنظافهوالاستقبالجده';
    if (n.includes('رياض1')) return 'قسمالنظافهوالاستقبالالرياض1';
    if (n.includes('رياض2')) return 'قسمالنظافهوالاستقبالالرياض2';
    if (n.includes('رياض')) return 'قسمالنظافهوالاستقبالالرياض';
    return 'قسمالاستقبالوالنظافه';
  }

  // 🏬 الفروع
  if (n.includes('فرع') && n.includes('جده')) return 'ادارهفرعجده';
  if (n.includes('فرع') && n.includes('رياض')) return 'ادارهفرعرياض';

  return n;
}


/* ========== تحميل الطلبات ========== */

// ========== تحميل الطلبات ==========
async function loadRequestsForUser(dept) {
  console.log("📨 إرسال طلب إلى السيرفر للقسم:", dept);

  // ✅ عرض رسالة انتظار أثناء التحميل
  document.getElementById('requestsContainer').innerHTML =
    '<div class="no-requests">جارٍ تحميل الطلبات...</div>';

  try {
    // ✅ جلب الطلبات من السيرفر
    const res = await fetch('/api/get_requests', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        role: currentUser.role,
        department:
          currentUser.role === 'مدير عام' && dept === 'all'
            ? 'all'
            : dept,
      }),
    });

    const data = await res.json();
    console.log("✅ الرد من السيرفر:", data);

    // ✅ فلترة الطلبات حسب القسم المختار
    let finalList = [];
    const deptStd = normalizeDepartmentJS(dept);

    if (dept === 'all') {
      // المدير العام يشوف كل الطلبات
      finalList = data;
    } else {
      // المدير العام يشوف فقط الطلبات اللي هذا القسم "استلمها"
      finalList = data.filter((r) => {
        const recv = normalizeDepartmentJS(r['القسم المستلم']);
        return recv.includes(deptStd);
      });
    }

    // 🧠 اختبار مؤقت لعرض البيانات القادمة من السيرفر
    console.log("📦 عدد الطلبات بعد الفلترة:", finalList.length);
    console.log("🧾 بيانات أول طلب:", finalList[0]);

    // ✅ عرض النتيجة في الصفحة
    renderRequests('requestsContainer', finalList);

  } catch (e) {
    console.error('❌ فشل تحميل الطلبات:', e);
    document.getElementById('requestsContainer').innerHTML =
      '<div class="error-message">حدث خطأ أثناء تحميل الطلبات</div>';
  }
}

// 🔹 لجعل الدالة متاحة في onchange
window.loadRequestsForUser = loadRequestsForUser;



// ========== عرض الطلبات ==========
function renderRequests(containerId, list) {
  const c = document.getElementById(containerId);
  if (!Array.isArray(list) || !list.length) {
    c.innerHTML = '<div class="no-requests">لا توجد طلبات.</div>';
    return;
  }

  c.innerHTML = list.map(req => {
    const recvDept = normalizeDepartmentJS(req['القسم المستلم'] || '');
    const userDept = normalizeDepartmentJS(currentUser.department || '');
    const status = req['الحالة'] || '';
    const fileName = req['المرفق'] || '';

    // ===================== صلاحيات تغيير الحالة =====================
    const canChangeStatus =
      (
        ["بلال رباح البلادي", "امجد عايض المحمدي", "شهد خليل عبيدالله الحربي"].includes(currentUser.name)
        && currentUser.role === "مدير عام"
      )
        ? recvDept.includes(userDept) // المدير العام يغيّر فقط طلبات قسمه
        : (recvDept.includes(userDept) && currentUser.role === "مدير قسم");

    // ===================== صلاحيات التوكيل =====================
    let canDelegate = false;
    let delegateOptions = [];

    // 🟦 بلال وأمجد: يقدرون يوكلون لأي مدير قسم داخل قسمهم فقط
    if (["بلال رباح البلادي", "امجد عايض المحمدي"].includes(currentUser.name) && currentUser.role === "مدير عام") {
      canDelegate = recvDept.includes(userDept);
      if (canDelegate) {
        delegateOptions = allEmployees.filter(e => e['الصلاحية'] === 'مدير قسم');
      }
    }

    // 🟪 شهد: توكيل فقط لموظفي الموارد البشرية داخل قسمها
    else if (currentUser.name === "شهد خليل عبيدالله الحربي" && currentUser.role === "مدير عام") {
      canDelegate = recvDept === "ادارهالمواردالبشريه";
      if (canDelegate) {
        delegateOptions = allEmployees.filter(e =>
          normalizeDepartmentJS(e['القسم']) === "ادارهالمواردالبشريه" &&
          e['الصلاحية'] === 'موظف'
        );
      }
    }

    // 🟩 مدير القسم: يوكل فقط لموظفي قسمه
    else if (currentUser.role === "مدير قسم") {
      canDelegate = recvDept === userDept;
      delegateOptions = allEmployees.filter(e =>
        normalizeDepartmentJS(e['القسم']) === userDept &&
        e['الصلاحية'] === 'موظف'
      );
    }

    // ===================== بناء البطاقة =====================
    return `
      <div class="request-card" data-id="${req['رقم الطلب'] || ''}">
        <div class="status-header ${statusToClass(status)}"></div>
        <div class="card-content">
          <div class="card-top">
            <div class="request-id">#${req['رقم الطلب'] || ''}</div>
            <div class="request-date">${req['التاريخ'] || ''}</div>
          </div>

          <h3 class="request-title">${req['العنوان'] || ''}</h3>
          <p class="request-desc">${req['الوصف'] || ''}</p>

          <div class="request-meta">
            <div class="meta-item"><i class="fas fa-user"></i>
              المرسل: ${req['اسم المرسل'] || '-'} (${req['القسم المرسل'] || '-'})
            </div>
            <div class="meta-item"><i class="fas fa-user-check"></i>
              المستلم: ${req['اسم المستلم'] || '-'} (${req['القسم المستلم'] || '-'})
            </div>
          </div>

          <div class="status-info">
            <div><span class="status-label">الحالة:</span>
              <span class="status-badge ${statusToClass(status)}">${status || '-'}</span>
            </div>
            <div><span class="status-label">آخر تحديث:</span> ${req['آخر تحديث بواسطة'] || '-'}</div>
          </div>

          ${fileName
            ? `<div class="meta-item"><i class="fas fa-paperclip"></i>
                 <button class="view-file-btn" onclick="openFileViewer('/uploads/${fileName}')">
                   عرض المرفق
                 </button></div>`
            : `<div class="meta-item"><i class="fas fa-paperclip"></i> لا يوجد مرفق</div>`}

          <!-- ✅ تغيير الحالة -->
          <div class="update-section">
            ${canChangeStatus ? `
              <select class="status-select" onchange="updateRequestStatus('${req['رقم الطلب']}', this.value)">
                <option value="">تغيير الحالة</option>
                <option value="جديد">جديد</option>
                <option value="قيد المراجعة">قيد المراجعة</option>
                <option value="جاري التنفيذ">جاري التنفيذ</option>
                <option value="معلق">معلق</option>
                <option value="مغلق">مغلق</option>
              </select>` :
              `<select class="status-select" disabled><option>لا يمكن التعديل</option></select>`
            }
            <span id="timer-${req['رقم الطلب']}" class="timer-text">${req['الوقت'] || '00:00:00'}</span>
          </div>

          <!-- ✅ التوكيل -->
          ${canDelegate ? `
            <div class="delegate-section" style="margin-top:10px;">
              <select class="form-control delegate-select" onchange="delegateRequest('${req['رقم الطلب']}', this.value)">
                <option value="">توكيل إلى...</option>
                ${delegateOptions.map(e => `<option value="${e['الاسم']}">${e['الاسم']}</option>`).join('')}
              </select>
            </div>
          ` : ''}
        </div>
      </div>`;
  }).join('');

  // ✅ تشغيل المؤقتات حسب الحالة
  setTimeout(() => {
    list.forEach(req => {
      const status = (req['الحالة'] || '').trim();
      const timeStr = (req['الوقت'] || '00:00:00').trim();
      const [h, m, s] = timeStr.split(':').map(Number);
      const totalSec = (h || 0) * 3600 + (m || 0) * 60 + (s || 0);

      if (status === 'جاري التنفيذ') startTimer(req['رقم الطلب'], totalSec);
      else if (status === 'معلق') pauseTimer(req['رقم الطلب']);
    });
  }, 300);
}


/* ========== ألوان الحالات ========== */
function statusToClass(s) {
  if (s.includes('جديد')) return 'status-new';
  if (s.includes('مغلق')) return 'status-closed';
  if (s.includes('جاري')) return 'status-in-progress';
  if (s.includes('مرفوض')) return 'status-rejected';
  return 'status-assigned';
}

/* ========== فلترة حسب الحالة ========== */
function filterRequestsByStatus() {
  const status = document.getElementById('statusFilter').value.trim();
  const allCards = document.querySelectorAll('.request-card');
  allCards.forEach(card => {
    const text = card.innerText || '';
    card.style.display = (!status || text.includes(status)) ? 'block' : 'none';
  });
}

/* ========== دالة تحديث الحالة ========== */
async function updateRequestStatus(reqId, newStatus) {
  if (!newStatus) return;

  // ✅ التحقق من الصلاحيات
  const reqCard = document.querySelector(`[data-id='${reqId}']`);
  if (!reqCard) return;

  const receiverText = reqCard.querySelector('.meta-item:nth-child(2)')?.innerText || '';
  const isSameDept = normalizeDepartmentJS(receiverText).includes(normalizeDepartmentJS(currentUser.department));
  const isGeneralManager = currentUser.role === "مدير عام";

  // 🔒 المدير العام لا يمكنه تغيير حالة طلبات الأقسام الأخرى
  if (isGeneralManager && !isSameDept) {
    showToast("⚠️ لا يمكنك تغيير حالة طلبات الأقسام الأخرى", "error");
    return;
  }

  const updater = currentUser.name;
  const payload = { requestId: reqId, status: newStatus, updater };

  if (newStatus === "جاري التنفيذ") startTimer(reqId);
  if (newStatus === "معلق") pauseTimer(reqId);
  if (newStatus === "مغلق") payload.duration = stopTimer(reqId);

  try {
    const res = await fetch('/api/update_request_status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.success) {
      showToast("تم تحديث الحالة بنجاح ✅", "success");
      await loadRequests();
    } else {
      showToast("حدث خطأ أثناء التحديث ❌", "error");
    }
  } catch (e) {
    console.error(e);
    showToast("فشل الاتصال بالخادم", "error");
  }
}

/* ========== نظام المؤقت ========== */
let timers = {};
let savedTimes = {}; // 🧠 لحفظ الوقت عند التوقف المؤقت

function startTimer(reqId, baseSeconds = null) {
  const el = document.getElementById(`timer-${reqId}`);
  if (!el) return;

  // ⏱️ إذا فيه وقت محفوظ نكمل منه، وإذا لا نبدأ من baseSeconds
  let seconds = savedTimes[reqId] ?? baseSeconds ?? 0;

  clearInterval(timers[reqId]);
  timers[reqId] = setInterval(() => {
    seconds++;
    savedTimes[reqId] = seconds; // 🔹 نحفظ الوقت باستمرار
    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    el.textContent = `${h}:${m}:${s}`;

    // 🎨 تغيير اللون حسب المدة
    if (seconds < 300) el.style.background = '#e8f5e9'; // أخضر فاتح
    else if (seconds < 1800) el.style.background = '#fff8e1'; // أصفر
    else el.style.background = '#ffebee'; // أحمر فاتح
  }, 1000);
}

function pauseTimer(reqId) {
  if (timers[reqId]) {
    clearInterval(timers[reqId]);
    timers[reqId] = null;
  }
}

function stopTimer(reqId) {
  if (timers[reqId]) {
    clearInterval(timers[reqId]);
    delete timers[reqId];
  }
  const el = document.getElementById(`timer-${reqId}`);
  const time = el ? el.textContent : "00:00:00";

  // 🧹 حذف الوقت المحفوظ بعد الإغلاق
  delete savedTimes[reqId];

  return time;
}


/* ========== Toast بسيط للإشعارات ========== */
function showToast(msg, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast show ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}


/* ========== إرسال طلب جديد ========== */
document.getElementById('newRequestForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const title = document.getElementById('requestTitle').value.trim();
  const desc  = document.getElementById('requestDesc').value.trim();
  const targetDept = document.getElementById('targetDept').value.trim();
  const fileInput = document.getElementById('requestFile');

  if (!title || !desc || !targetDept) {
    alert("الرجاء تعبئة جميع الحقول قبل الإرسال");
    return;
  }

  const formData = new FormData();
  formData.append('title', title);
  formData.append('description', desc);
  formData.append('targetDept', targetDept);
  formData.append('senderDept', currentUser.department);
  formData.append('senderName', currentUser.name);
  if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
  }

  try {
    const res = await fetch('/api/create_request', { method: 'POST', body: formData });
    const data = await res.json();

    if (data.success) {
      alert("✅ تم إرسال الطلب بنجاح");
      closeNewRequestModal();
      document.getElementById('newRequestForm').reset();
      await loadRequests(); // ✅ تحديث الطلبات بعد الإرسال
    } else {
      alert("❌ حدث خطأ أثناء الإرسال: " + (data.message || 'غير معروف'));
    }
  } catch (e) {
    console.error('❌ خطأ أثناء الإرسال:', e);
    alert("❌ لم يتم الاتصال بالخادم، تأكد من أن السيرفر يعمل.");
  }
});

/* ========== عرض المرفقات ========== */
function openFileViewer(url) {
  const viewerBody = document.getElementById('fileViewerBody');
  viewerBody.innerHTML = '';
  const ext = url.split('.').pop().toLowerCase();

  if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
    viewerBody.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:10px;">`;
  } else if (ext === 'pdf') {
    viewerBody.innerHTML = `<iframe src="${url}" width="100%" height="500px" style="border:none;border-radius:10px;"></iframe>`;
  } else if (['xlsx', 'xls', 'docx', 'doc'].includes(ext)) {
    viewerBody.innerHTML = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${window.location.origin + url}" width="100%" height="500px" frameborder="0"></iframe>`;
  } else {
    viewerBody.innerHTML = `<p>لا يمكن عرض هذا النوع من الملفات مباشرة. يمكنك تحميله <a href="${url}" target="_blank">من هنا</a>.</p>`;
  }

  document.getElementById('fileViewerModal').style.display = 'flex';
}

function closeFileViewer(e) {
  const modal = document.getElementById('fileViewerModal');
  if (e.target === modal || e.target.classList.contains('close-btn')) {
    modal.style.display = 'none';
    document.getElementById('fileViewerBody').innerHTML = '';
  }
}

/* ========== فتح وغلق نموذج الطلب الجديد مع الإغلاق عند النقر بالخارج ========== */
function openNewRequestModal() {
  const modal = document.getElementById('newRequestModal');
  modal.style.display = 'flex';
  modal.style.opacity = '1';
  modal.style.pointerEvents = 'auto';

  // ✅ إضافة مراقب للنقر خارج النافذة بعد فتحها بقليل لتجنب التقاط نقرة الزر نفسه
  setTimeout(() => {
    document.addEventListener('click', handleOutsideClick);
  }, 200);
}

function closeNewRequestModal() {
  const modal = document.getElementById('newRequestModal');
  modal.style.display = 'none';
  modal.style.opacity = '0';
  modal.style.pointerEvents = 'none';

  // ✅ إزالة المراقب بعد الإغلاق
  document.removeEventListener('click', handleOutsideClick);
}

// 🔹 دالة تتحقق من النقر خارج نافذة المحتوى
function handleOutsideClick(e) {
  const modal = document.getElementById('newRequestModal');
  const content = modal.querySelector('.request-modal-content');
  const openButton = document.querySelector('.new-request-btn'); // زر الفتح نفسه

  // ✅ إذا المستخدم ضغط خارج النافذة، وليس على الزر
  if (
    modal.style.display === 'flex' &&
    !content.contains(e.target) &&
    e.target !== openButton &&
    !openButton.contains(e.target)
  ) {
    closeNewRequestModal();
  }
}


/* ========== زر الخروج ========== */
function logout() {
  if (confirm('هل أنت متأكد أنك تريد تسجيل الخروج؟')) {
    localStorage.removeItem('currentUser');
    alert('تم تسجيل الخروج بنجاح ✅');
    window.location.href = 'Login.html';
  }
}

async function exportRequests() {
  const start = document.getElementById('startDate').value || null;
  const end = document.getElementById('endDate').value || null;

  const res = await fetch('/api/export_requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      department: currentUser.department,
      start_date: start,
      end_date: end
    })
  });

  const data = await res.json();
  if (data.success && data.file)
    window.location.href = `/download/${data.file}`;
  else
    alert('❌ حدث خطأ أثناء تصدير الطلبات');
}

/* ========== دالة التوكيل ========== */
async function delegateRequest(reqId, delegateName) {
  if (!delegateName) return;
  if (!confirm(`هل تريد توكيل الطلب رقم ${reqId} إلى ${delegateName}؟`)) return;

  try {
    const res = await fetch('/api/delegate_request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        requestId: reqId,
        delegate: delegateName,
        delegatedBy: currentUser.name
      })
    });

    const data = await res.json();
    if (data.success) {
      showToast(`تم توكيل الطلب إلى ${delegateName} ✅`, "success");
      await loadRequests();
    } else {
      showToast("❌ فشل في عملية التوكيل", "error");
    }
  } catch (e) {
    console.error('❌ خطأ أثناء التوكيل:', e);
    showToast("فشل الاتصال بالخادم", "error");
  }
}

</script>

<style>
.toast{
  position:fixed;bottom:30px;left:50%;
  transform:translateX(-50%);
  padding:12px 25px;border-radius:10px;
  color:#fff;font-size:15px;opacity:0;
  transition:all .4s ease;z-index:9999;
}
.toast.show{opacity:1;bottom:50px;}
.toast.success{background:#4caf50;}
.toast.error{background:#e74c3c;}
.toast.info{background:#3498db;}
.card-glow{border:2px solid #81c784;box-shadow:0 0 15px rgba(129,199,132,0.6);}
</style>


</body>
</html>
